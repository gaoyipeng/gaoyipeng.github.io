---
title: Activiti（21） 网关
date: 2020-09-07 16:16:23
tags: Activiti
categories: Activiti
description: Activiti（21） 网关
typora-root-url: ..
password: kiki
---

网关用来控制流程的流向。网关一共有4种：

![image-20200907164855419](/images/activiti6-21/image-20200907164855419.png)

## 1、互斥网关（排他网关）

排他网关， 用来在流程中实现**决策**。当流程执行到这个网关，所有外出顺序流都会被处理一遍。 其中条件解析为true的顺序流（或者没有设置条件，概念上在顺序流上定义了一个*'true'*） 会被选中，让流程继续运行。

注意：**如果多个顺序流的条件结果为true， 那么XML中的第一个顺序流（也只有这一条）会被选中，并用来继续运行流程。 如果没有选中任何顺序流，会抛出一个异常。**

```xml
<exclusiveGateway id="exclusiveGw" name="Exclusive Gateway" />
```

### 1.1 条件表达式

顺序流上可以设置条件表达式（**UEL**），使用的表达式需要返回boolean值，否则会在解析表达式时抛出异常。条件表达式分为2种：**值表达式**和**方法表达式**。

```xml
<!--值表达式:order为流程变量-->
<conditionExpression xsi:type="tFormalExpression">
  <![CDATA[${order.price > 100 && order.price < 250}]]>
</conditionExpression>
<!--方法表达式:调用方法返回一个boolean值-->
<conditionExpression xsi:type="tFormalExpression">
  <![CDATA[${order.isStandardOrder()}]]>
</conditionExpression>
```

### 1.2 默认顺序流

所有的BPMN 2.0任务和网关都可以设置一个并且只能设置一个**默认顺序流**。 默认顺序流的条件设置不会生效。

默认顺序流显示为了普通顺序流，起点有一个“斜线”标记。

![image-20200907173727499](/images/activiti6-21/image-20200907173727499.png)

## 2、并行网关

**并行网关**，它允许将流程 *分*成多条分支，也可以把多条分支 *汇聚*到一起。

并行网关的功能是基于进入和外出的顺序流的：

- **分支：** 并行后的所有外出顺序流，为每个顺序流都创建一个并发分支。
- **汇聚：** 所有到达并行网关，在此等待的进入分支， 直到**所有**进入顺序流的分支都到达以后， 流程就会通过汇聚网关。

注意，如果同一个并行网关有多个进入和多个外出顺序流， 它就同时具有**分支和汇聚功能**。 这时，网关会先汇聚所有进入的顺序流，然后再切分成多个并行分支。

```xml
<parallelGateway id="myParallelGateway" />
```

## 3、包含网关（包容性网关）

**包含网关**可以看做是排他网关和并行网关的结合体。 和排他网关一样，你可以在外出顺序流上定义条件，包含网关会解析它们。 但是主要的区别是包含网关可以选择多于一条顺序流，这和并行网关一样。

如果没有条件为true，就会抛出一个异常。 如果想避免异常，可以定义一个默认顺序流。

包含网关的功能是基于进入和外出顺序流的：

- **分支：** 所有外出顺序流的条件都会被解析，结果为true的顺序流会以并行方式继续执行， 会为每个顺序流创建一个分支。
- **汇聚：** 所有并行分支到达包含网关，会进入等待状态， 直到每个包含流程token的进入顺序流的分支都到达。 这是与并行网关的最大不同。换句话说，**包含网关只会等待被选中执行了的进入顺序流**。 在汇聚之后，流程会穿过包含网关继续执行。

注意，如果同一个包含节点拥有多个进入和外出顺序流， 它就会同时**含有分支和汇聚功能**。 这时，网关会先汇聚所有拥有流程token的进入顺序流， 再根据条件判断结果为true的外出顺序流，为它们生成多条并行分支。

```xml
<inclusiveGateway id="myInclusiveGateway" />
```

## 4、事件网关

基于事件网关允许根据事件判断流向。网关的每个外出顺序流都要连接到一个中间捕获事件。 当流程到达一个事件网关，网关会进入等待状态：会暂停执行。 与此同时，会为每个外出顺序流创建相对的事件订阅。

**注意**基于事件网关的外出顺序流和普通顺序流不同。这些顺序流不会真的"执行"。 相反，它们让流程引擎去决定执行到事件网关的流程需要订阅哪些事件。 要考虑以下条件：

- 基于事件网关必须有两条或以上外出顺序流。
- 基于事件网关后，只能使用`intermediateCatchEvent`类型。 （activiti不支持基于事件网关后连接ReceiveTask。）
- 连接到基于事件网关的`intermediateCatchEvent`只能有一条进入顺序流。

```xml
<eventBasedGateway id="gw1" />
```

这里我们看一下官方提供的示例：

![image-20200908105820475](/images/activiti6-21/image-20200908105820475.png)

上面的流程是一个使用基于事件网关的例子。当流程执行到基于事件网关时， 流程会暂停执行。与此同时，**流程实例会订阅信号事件，并创建一个10分钟后触发的定时器**。 如果10分钟内收到信号，定时器就会取消，流程会沿着信号执行。 如果信号没有出现，流程会沿着定时器的方向前进，信号订阅会被取消。