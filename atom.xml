<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Garnett 的博客</title>
  
  <subtitle>学然后知不足,教然后知困。知不足,然后能自反也;知困,然后能自强也</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.gaoyp.cn/"/>
  <updated>2020-03-15T16:04:25.907Z</updated>
  <id>http://blog.gaoyp.cn/</id>
  
  <author>
    <name>Garnett</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SpringMVC @ModelAttribute注解的用法</title>
    <link href="http://blog.gaoyp.cn/2020/03/15/springmvc-01/"/>
    <id>http://blog.gaoyp.cn/2020/03/15/springmvc-01/</id>
    <published>2020-03-15T14:13:33.000Z</published>
    <updated>2020-03-15T16:04:25.907Z</updated>
    
    <content type="html"><![CDATA[<p>@ModelAttribute主要的作用是将数据添加到对象模型中，在视图页面展示时使用。<br>@ModelAttribute 等价于 model.addAttribute(“abc”, “abc”); 或 map.put(“abc”,”abc”)</p><h2 id="小知识点"><a href="#小知识点" class="headerlink" title="小知识点"></a>小知识点</h2><p>首先我们需要知道，在SpringMVC中，以下3种写法效果相同。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;index1&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">public String index(Dog dog) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    dog.setName(&quot;二哈1&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    dog.setAge(1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    return &quot;index&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;index2&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">public String index1( Model model) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    Dog dog &#x3D; new Dog();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    dog.setName(&quot;二哈2&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    dog.setAge(2);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    model.addAttribute(&quot;dog&quot;,dog);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    return &quot;index&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;index3&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">public String index2( Map map) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    Dog dog &#x3D; new Dog();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    dog.setName(&quot;二哈3&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    dog.setAge(3);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    map.put(&quot;dog&quot;,dog);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    return &quot;index&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>index.jsp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType&#x3D;&quot;text&#x2F;html;charset&#x3D;UTF-8&quot; language&#x3D;&quot;java&quot; %&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&lt;%</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    String path &#x3D; request.getContextPath();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    String basePath &#x3D; request.getScheme() + &quot;:&#x2F;&#x2F;&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            + request.getServerName() + &quot;:&quot; + request.getServerPort()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">            + path + &quot;&#x2F;&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">%&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&lt;head&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &lt;title&gt;Index&lt;&#x2F;title&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    &lt;link rel&#x3D;&quot;stylesheet&quot; type&#x3D;&quot;text&#x2F;css&quot; href&#x3D;&quot;&lt;%&#x3D;basePath%&gt;statics&#x2F;css&#x2F;index.css&quot;&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;head&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&lt;h2&gt;Test success!&lt;&#x2F;h2&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">dog:$&#123;requestScope.dog&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;body&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;html&gt;</span></pre></td></tr></table></figure><p>分别访问<a href="http://localhost:8080/springmvc/index1" target="_blank" rel="noopener">http://localhost:8080/springmvc/index1</a><br><img src="/images/springmvc/dog1.png" alt="dog1"><br><a href="http://localhost:8080/springmvc/index2" target="_blank" rel="noopener">http://localhost:8080/springmvc/index2</a><br><img src="/images/springmvc/dog2.png" alt="dog2"><br><a href="http://localhost:8080/springmvc/index3" target="_blank" rel="noopener">http://localhost:8080/springmvc/index3</a><br><img src="/images/springmvc/dog3.png" alt="dog3"></p><h2 id="ModelAttribute修饰一个方法"><a href="#ModelAttribute修饰一个方法" class="headerlink" title="@ModelAttribute修饰一个方法"></a>@ModelAttribute修饰一个方法</h2><p>先贴出一个实体类Dog:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public class Dog &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    private String name;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    private Integer age;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    public Dog() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    public Dog(String name, Integer age) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        this.name &#x3D; name;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        this.age &#x3D; age;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    @Override</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    public String toString() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        return &quot;Dog&#123;&quot; +</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                &quot;name&#x3D;&#39;&quot; + name + &#39;\&#39;&#39; +</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">                &quot;, age&#x3D;&quot; + age +</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">                &#39;&#125;&#39;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">  ...getter,setter</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p><strong>以下示例1，2，3类似，被@ModelAttribute注释的方法会在此controller每个方法执行前被执行，因此对于一个Controller映射有多个URL的用法来说，要谨慎使用。<br></strong></p><h3 id="例1：-ModelAttribute标注在-返回值为void的方法上"><a href="#例1：-ModelAttribute标注在-返回值为void的方法上" class="headerlink" title="例1： @ModelAttribute标注在 返回值为void的方法上"></a>例1： @ModelAttribute标注在 返回值为void的方法上</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@Controller</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">public class DemoController &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    @ModelAttribute</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    public void testModelAttribute(Model model)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        model.addAttribute(&quot;attribute&quot;,&quot;attribute&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    @RequestMapping(value &#x3D; &quot;&#x2F;index1&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    public String index(Dog dog) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        dog.setName(&quot;二哈1&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        dog.setAge(1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        return &quot;index&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>index.jsp:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&lt;h2&gt;Test success!&lt;&#x2F;h2&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">dog:$&#123;requestScope.dog&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&lt;br&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">attribute:$&#123;requestScope.attribute&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;body&gt;</span></pre></td></tr></table></figure><p><img src="/images/springmvc/model1.png" alt="model1"></p><p>说明：testModelAttribute方法在 index 方法之前先被调用，它在model中添加了(“attribute”,”attribute”),在它执行后 index 被调用，返回视图index和model,此时的model中包含2个k-v键值对。</p><p><font color="red">注意:</font>如果我们修改testModelAttribute和index方法如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@ModelAttribute</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    public void testModelAttribute(Model model)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        Dog dog &#x3D; new Dog(&quot;德牧&quot;,2);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        model.addAttribute(&quot;dog&quot;,dog);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F;model.addAttribute(&quot;attribute&quot;,&quot;attribute&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;index1&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">public String index(Dog dog) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    dog.setAge(1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    return &quot;index&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p><img src="/images/springmvc/model1-1.png" alt="model1-1.png"></p><p><font color="red">结论：方法返回的model值相同（inde方法model为形参Dog首字母小写），均为dog。那么。testModelAttribute方法产生的model中的dog中的属性值，会覆盖掉index方法产生的model中的dog中的为null的属性值。</font></p><h3 id="例2：-ModelAttribute标注在-返回具体类的方法"><a href="#例2：-ModelAttribute标注在-返回具体类的方法" class="headerlink" title="例2： @ModelAttribute标注在 返回具体类的方法"></a>例2： @ModelAttribute标注在 返回具体类的方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@ModelAttribute</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">public Dog testModelAttribute()&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Dog dog &#x3D; new Dog(&quot;德牧&quot;,3);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    return dog;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;index1&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">public String index() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    return &quot;index&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p><img src="/images/springmvc/model2.png" alt="model2.png"></p><p>说明：这种情况，model属性的名称没有指定，它由返回类型隐含表示，如这个方法返回Dog类型，那么这个model属性的名称是dog(首字母小写)。</p><h3 id="例3：-ModelAttribute-value-””-注释返回具体类的方法，但是指明了value值"><a href="#例3：-ModelAttribute-value-””-注释返回具体类的方法，但是指明了value值" class="headerlink" title="例3： @ModelAttribute(value=””)注释返回具体类的方法，但是指明了value值"></a>例3： @ModelAttribute(value=””)注释返回具体类的方法，但是指明了value值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@ModelAttribute(value &#x3D; &quot;attribute&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">public Dog testModelAttribute()&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Dog dog &#x3D; new Dog(&quot;德牧&quot;,2);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    return dog;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;index1&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">public String index(Dog dog) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    dog.setName(&quot;二哈1&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    dog.setAge(1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    return &quot;index&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p><img src="/images/springmvc/model3.png" alt="model3.png"></p><p>说明：这个例子中使用@ModelAttribute注释的value属性，来指定model属性的名称。model属性对象就是方法的返回值。</p><h3 id="例4：-ModelAttribute和-RequestMapping同时注释一个方法"><a href="#例4：-ModelAttribute和-RequestMapping同时注释一个方法" class="headerlink" title="例4： @ModelAttribute和@RequestMapping同时注释一个方法"></a>例4： @ModelAttribute和@RequestMapping同时注释一个方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@ModelAttribute</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">public  Dog  testModelAttribute()&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Dog dog &#x3D; new Dog(&quot;德牧&quot;,2);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    return dog;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;index&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">@ModelAttribute(value &#x3D; &quot;attribute&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">public String index() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    return &quot;attributeValue&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p><img src="/images/springmvc/model4.png" alt="model4.png"></p><p>说明：index()这个方法的返回值并不是表示一个视图名称，而是model属性的值，视图名称由RequestToViewNameTranslator根据请求”/index”转换为逻辑视图index。<br>   Model属性名称有@ModelAttribute(value=””)指定，相当于在request中封装了key=”attribute”，value=”attributeValue”。</p><h2 id="ModelAttribute注解修饰一个方法的参数"><a href="#ModelAttribute注解修饰一个方法的参数" class="headerlink" title="@ModelAttribute注解修饰一个方法的参数"></a>@ModelAttribute注解修饰一个方法的参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@ModelAttribute(value &#x3D; &quot;dog&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  public Dog testModelAttribute()&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">      Dog dog &#x3D; new Dog(&quot;德牧&quot;,2);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">      return dog;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  @RequestMapping(value &#x3D; &quot;&#x2F;index1&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  public String index(@ModelAttribute(value &#x3D; &quot;dog&quot;) Dog dog) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">      dog.setName(&quot;二哈&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">      return &quot;index&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr></table></figure><p><img src="/images/springmvc/param1.png" alt="param1.png"></p><p>说明：在这个例子里，@ModelAttribute(value = “dog”) Dog dog 注释方法参数，参数dog的值来源于testModelAttribute()方法中的model属性。<br>   　　此时如果方法体没有标注@SessionAttributes(“dog”)，那么scope为request，如果标注了，那么scope为session</p><h2 id="ModelAttribute注解修饰一个方法的返回值"><a href="#ModelAttribute注解修饰一个方法的返回值" class="headerlink" title="@ModelAttribute注解修饰一个方法的返回值"></a>@ModelAttribute注解修饰一个方法的返回值</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;index&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">public @ModelAttribute(value &#x3D; &quot;dog2&quot;) Dog  testModelAttribute()&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Dog dog &#x3D; new Dog(&quot;德牧&quot;,2);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    return dog;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>index.jsp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&lt;h2&gt;Test success!&lt;&#x2F;h2&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">dog2:$&#123;requestScope.dog2&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;body&gt;</span></pre></td></tr></table></figure><p><img src="/images/springmvc/return1.png" alt="return1.png"></p><p>说明： @ModelAttribute(value = “dog2”)，会添加返回值到model（ 名字为user2 ） 中供视图展示使用。</p><p>OK,都介绍完了，有点绕，多看几遍就好了。</p><p>参考：<a href="https://blog.csdn.net/leo3070/article/details/81046383" target="_blank" rel="noopener">https://blog.csdn.net/leo3070/article/details/81046383</a></p>]]></content>
    
    <summary type="html">
    
      SpringMVC @ModelAttribute注解的用法
    
    </summary>
    
    
      <category term="SpringMVC" scheme="http://blog.gaoyp.cn/categories/SpringMVC/"/>
    
    
      <category term="SpringMVC" scheme="http://blog.gaoyp.cn/tags/SpringMVC/"/>
    
  </entry>
  
  <entry>
    <title>Spring源码学习（一）：环境准备</title>
    <link href="http://blog.gaoyp.cn/2020/03/14/spring-study-01/"/>
    <id>http://blog.gaoyp.cn/2020/03/14/spring-study-01/</id>
    <published>2020-03-14T08:03:51.000Z</published>
    <updated>2020-03-14T11:19:14.430Z</updated>
    
    <content type="html"><![CDATA[<h2 id="构建工具Gradle"><a href="#构建工具Gradle" class="headerlink" title="构建工具Gradle"></a>构建工具Gradle</h2><p>Spring 源码不是使用我们常用的Maven构建，使用Gradle。 Gradle不是我们介绍的重点，我们在本地Window10环境下配置好环境即可。</p><p>参考：<a href="https://www.cnblogs.com/NyanKoSenSei/p/11458953.html" target="_blank" rel="noopener">Gradle的安装与配置</a></p><p><img src="/images/spring/gradle-v.png" alt="gradle-v.png"></p><h2 id="Spring源码包准备"><a href="#Spring源码包准备" class="headerlink" title="Spring源码包准备"></a>Spring源码包准备</h2><h3 id="下载预编译"><a href="#下载预编译" class="headerlink" title="下载预编译"></a>下载预编译</h3><p>从Github下载源码包：<a href="https://github.com/spring-projects/spring-framework/releases" target="_blank" rel="noopener">下载地址</a>,我下载的是：spring-framework-5.2.3.RELEASE</p><p>解压文件，查看import-into-idea.md文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">The following has been tested against IntelliJ IDEA 2016.2.2</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">## Steps</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">_Within your locally cloned spring-framework working directory:_</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">1. Precompile &#96;spring-oxm&#96; with &#96;.&#x2F;gradlew :spring-oxm:compileTestJava&#96;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">2. Import into IntelliJ (File -&gt; New -&gt; Project from Existing Sources -&gt; Navigate to directory -&gt; Select build.gradle)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">3. When prompted exclude the &#96;spring-aspects&#96; module (or after the import via File-&gt; Project Structure -&gt; Modules)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">4. Code away</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">## Known issues</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">1. &#96;spring-core&#96; and &#96;spring-oxm&#96; should be pre-compiled due to repackaged dependencies.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">See &#96;*RepackJar&#96; tasks in the build and https:&#x2F;&#x2F;youtrack.jetbrains.com&#x2F;issue&#x2F;IDEA-160605).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">2. &#96;spring-aspects&#96; does not compile due to references to aspect types unknown to</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">IntelliJ IDEA. See https:&#x2F;&#x2F;youtrack.jetbrains.com&#x2F;issue&#x2F;IDEA-64446 for details. In the meantime, the</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">&#39;spring-aspects&#39; can be excluded from the project to avoid compilation errors.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">3. While JUnit tests pass from the command line with Gradle, some may fail when run from</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">IntelliJ IDEA. Resolving this is a work in progress. If attempting to run all JUnit tests from within</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">IntelliJ IDEA, you will likely need to set the following VM options to avoid out of memory errors:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    -XX:MaxPermSize&#x3D;2048m -Xmx2048m -XX:MaxHeapSize&#x3D;2048m</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">4. If you invoke &quot;Rebuild Project&quot; in the IDE, you&#39;ll have to generate some test</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">resources of the &#96;spring-oxm&#96; module again (&#96;.&#x2F;gradlew :spring-oxm:compileTestJava&#96;)    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">## Tips</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">In any case, please do not check in your own generated .iml, .ipr, or .iws files.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">You&#39;ll notice these files are already intentionally in .gitignore. The same policy goes for eclipse metadata.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">## FAQ</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">Q. What about IntelliJ IDEA&#39;s own [Gradle support](https:&#x2F;&#x2F;confluence.jetbrains.net&#x2F;display&#x2F;IDEADEV&#x2F;Gradle+integration)?</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">A. Keep an eye on https:&#x2F;&#x2F;youtrack.jetbrains.com&#x2F;issue&#x2F;IDEA-53476</span></pre></td></tr></table></figure><p>在解压目录下执行预编译命令：gradlew :spring-oxm:compileTestJava命令</p><p><img src="/images/spring/init-project.png" alt="init-project.png"></p><p>最后报了点奇奇怪怪的错误，看不懂，不管他，直接导入IDEA。</p><h3 id="导入idea"><a href="#导入idea" class="headerlink" title="导入idea"></a>导入idea</h3><p>import-into-idea.md文件，已经说明了导入步骤：</p><p>File -&gt; New -&gt; Project from Existing Sources -&gt; Navigate to directory -&gt; Select build.gradle</p><p>然后耐心等待jar包下载完<del>~</del></p><p><img src="/images/spring/spring-idea.png" alt="spring-idea.png"></p><p>到这一步，基本完工，本节的目的只是为了导入spring工程后代码别飘红就行，要不看着报错很糟心。</p><p>接下来开始源码学习，希望自己可以坚持下去，不写了，打把LOL去。</p>]]></content>
    
    <summary type="html">
    
      本地IDEA导入spring-framework-5.2.3.RELEASE
    
    </summary>
    
    
      <category term="Spring" scheme="http://blog.gaoyp.cn/categories/Spring/"/>
    
    
      <category term="Spring" scheme="http://blog.gaoyp.cn/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>解决CentOS7克隆虚拟机，ifconfig命令不显示ip地址问题</title>
    <link href="http://blog.gaoyp.cn/2020/03/12/vmware-01/"/>
    <id>http://blog.gaoyp.cn/2020/03/12/vmware-01/</id>
    <published>2020-03-12T04:29:39.000Z</published>
    <updated>2020-03-12T04:55:34.143Z</updated>
    
    <content type="html"><![CDATA[<h2 id="事故起因"><a href="#事故起因" class="headerlink" title="事故起因"></a>事故起因</h2><p>昨晚遇到个问题，我本机开了3个centos7 虚拟机，都是使用VMware克隆出来的。然后，电脑卡死~</p><p>重启电脑后，再次打开虚拟机，发现Xsheel无法连接了，进入虚拟机使用ipconfig查看ip地址，发现：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">[root@localhost admin]# ifconfig</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker0: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        inet6 fe80::42:abff:fe00:ce0c  prefixlen 64  scopeid 0x20&lt;link&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        ether 02:42:ab:00:ce:0c  txqueuelen 0  (Ethernet)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        RX packets 0  bytes 0 (0.0 B)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        TX packets 29  bytes 3240 (3.1 KiB)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">lo: flags&#x3D;73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        RX packets 12  bytes 1068 (1.0 KiB)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        TX packets 12  bytes 1068 (1.0 KiB)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">vethe27fbd4: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        inet6 fe80::10ea:7bff:feb5:a3d7  prefixlen 64  scopeid 0x20&lt;link&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        ether 12:ea:7b:b5:a3:d7  txqueuelen 0  (Ethernet)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        RX packets 0  bytes 0 (0.0 B)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        TX packets 37  bytes 3888 (3.7 KiB)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">virbr0: flags&#x3D;4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        inet 192.168.122.1  netmask 255.255.255.0  broadcast 192.168.122.255</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        ether 52:54:00:80:2c:25  txqueuelen 1000  (Ethernet)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">        RX packets 0  bytes 0 (0.0 B)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">        TX packets 0  bytes 0 (0.0 B)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">[root@localhost admin]#</span></pre></td></tr></table></figure><p>可以看到不显示eth33.这样我们就无法得知虚拟机ip。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="重建适配器-在vmware虚拟机中执行"><a href="#重建适配器-在vmware虚拟机中执行" class="headerlink" title="重建适配器:在vmware虚拟机中执行"></a>重建适配器:在vmware虚拟机中执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl stop NetworkManager</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">systemctl disable NetworkManager</span></pre></td></tr></table></figure><h3 id="然后，关闭虚拟机（不然点击不了生成）"><a href="#然后，关闭虚拟机（不然点击不了生成）" class="headerlink" title="然后，关闭虚拟机（不然点击不了生成）"></a>然后，关闭虚拟机（不然点击不了生成）</h3><h3 id="设置虚拟机"><a href="#设置虚拟机" class="headerlink" title="设置虚拟机"></a>设置虚拟机</h3><p>依次点击：<br><img src="/images/vmware/setting.png" alt="setting.png"></p><p>再次使用ifconfig查看就可以看到eth33下的ip地址了。</p><p>参考：<a href="https://blog.csdn.net/qq_36434219/article/details/80671978" target="_blank" rel="noopener">https://blog.csdn.net/qq_36434219/article/details/80671978</a></p>]]></content>
    
    <summary type="html">
    
      解决CentOS7克隆虚拟机，ifconfig命令不显示ip地址问题
    
    </summary>
    
    
      <category term="VMware" scheme="http://blog.gaoyp.cn/categories/VMware/"/>
    
    
      <category term="VMware" scheme="http://blog.gaoyp.cn/tags/VMware/"/>
    
  </entry>
  
  <entry>
    <title>使用Docker创建Nginx，并部署Vue项目，同时实现Nginx日志分割</title>
    <link href="http://blog.gaoyp.cn/2020/03/08/nginx-01/"/>
    <id>http://blog.gaoyp.cn/2020/03/08/nginx-01/</id>
    <published>2020-03-08T02:28:34.000Z</published>
    <updated>2020-03-11T12:50:21.038Z</updated>
    
    <content type="html"><![CDATA[<p>前面的文章<a href="https://blog.gaoyp.cn/2020/01/19/docker-03/">docker常用命令及Dockerfile笔记</a>中，我们介绍了Docker、Dcokerfile基本知识，并且使用Docker创建了一个Nginx容器。</p><p>本节我们主要介绍，如何介绍如何使用Docker创建Nginx，并部署Vue项目，同时实现Nginx日志分割。</p><p>为了阅读方便，我们重新介绍使用Docker创建Nginx的步骤，和<a href="https://blog.gaoyp.cn/2020/01/19/docker-03/">docker常用命令及Dockerfile笔记</a>相比，有一些小的修改项。</p><h2 id="创建Nginx"><a href="#创建Nginx" class="headerlink" title="创建Nginx"></a>创建Nginx</h2><h3 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h3><p>拉取nginx镜像到本地：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker pull nginx:latest</span></pre></td></tr></table></figure><p>说明：docker pull 镜像名称:镜像tags。如果不加 tags，默认拉取最新镜像（latest）。</p><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol><li>创建挂载目录</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;&#123;conf,html,logs,conf.d&#125;</span></pre></td></tr></table></figure><ul><li>conf : 存放外置nginx配置文件</li><li>html : 存放Vue包</li><li>logs : 存放nginx日志文件</li><li>conf.d : 存放具体项目的nginx配置文件</li></ul><ol start="2"><li>将打包好的Vue项目包（一个名为dist的文件夹）放到 /usr/local/nginx/html 目录下。</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">[root@192 html]# ls -l &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">总用量 4</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">drwxrwxr-x. 9 admin admin 250 3月   7 17:17 dist</span></pre></td></tr></table></figure><ol start="3"><li><p>在/usr/local/nginx/conf下创建 nginx.conf 文件，作为外置配置文件使用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">user  nginx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">events &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    worker_connections  1024;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">http &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    default_type  application&#x2F;octet-stream;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    sendfile        on;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    #tcp_nopush     on;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    keepalive_timeout  65;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    #gzip  on;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure></li><li><p>在/usr/local/nginx/conf下创建 log_format.conf文件，作为<font color="red">日志分割</font>配置文件使用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">if ($time_iso8601 ~ &quot;^(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)T(\d&#123;2&#125;):(\d&#123;2&#125;):(\d&#123;2&#125;)&quot;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        set $year $1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        set $month $2;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        set $day $3;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        set $hour $4;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;$&#123;server_name&#125;_$&#123;year&#125;-$&#123;month&#125;-$&#123;day&#125;-$&#123;hour&#125;_access.log main;</span></pre></td></tr></table></figure><p>如上，可以实现日志的按小时分割，生产环境一般改为按天分割即可。</p></li></ol><p><font color="red">注意：</font>此处会按小时生成日志文件，Nginx容器需要有文件生成的权限，需要将nginx.conf的第一行改为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">user root</span></pre></td></tr></table></figure><ol start="5"><li>创建项目配置文件</li></ol><p>在nginx.conf中我们可以看到 include /etc/nginx/conf.d/*.conf 。Nginx会扫描这个目录下所有以.conf结尾的文件。</p><p>我个人习惯在nginx.conf设置全局配置，在/etc/nginx/conf.d/下创建单独的项目配置文件。这样更清晰一些。</p><p>在/usr/local/nginx/conf.d 目录下创建vip.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">[root@192 nginx]# vim conf.d&#x2F;vip.conf </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">server &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    listen       80;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    server_name  vip;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    include log_format.conf;    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    location &#x2F; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        index  index.html index.htm;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><ul><li>include: 引入前面我们定义的日志分割配置文件 log_format.conf</li><li>root：表示匹配成功之后进入的目录，我们创建容器后会把/usr/local/nginx/html/dist 目录下的文件拷贝到容器的/usr/share/nginx/html目录下。</li><li>index：表示默认的首页面</li></ul><ol start="5"><li>创建容器</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:80 --name nginx80 --restart&#x3D;always \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"> -v &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;dist&#x2F;:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"> -v &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf:&#x2F;etc&#x2F;nginx&#x2F;nginx.conf \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"> -v &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;:&#x2F;var&#x2F;log&#x2F;nginx \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> -v &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf.d:&#x2F;etc&#x2F;nginx&#x2F;conf.d \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"> -v &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;log_format.conf:&#x2F;etc&#x2F;nginx&#x2F;log_format.conf  nginx:latest</span></pre></td></tr></table></figure><p>如果返回一长串字符即为成功。</p><p>参数说明：</p><ul><li>-d 后台运行</li><li>-p 设置端口映射 宿主机端口：容器端口</li><li>--name 设置容器别名</li><li>--restart=always 设置容器开机启动</li><li>-v 数据卷映射 宿主机目录：容器目录。这样方便我们管理容器配置文件及日志文件</li></ul><h2 id="效果验证"><a href="#效果验证" class="headerlink" title="效果验证"></a>效果验证</h2><h3 id="浏览器访问Vue项目"><a href="#浏览器访问Vue项目" class="headerlink" title="浏览器访问Vue项目"></a>浏览器访问Vue项目</h3><p><img src="/images/nginx/vue-index.jpg" alt="vue-index.jpg"></p><p>部署Vue前端项目成功</p><h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">[root@192 logs]# ll</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">总用量 8</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-rw-r--r--. 1 root root    0 3月   9 11:08 access.log</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">-rw-r--r--. 1 root root  291 3月   9 11:08 error.log</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">-rw-r--r--. 1 root root 2110 3月   9 11:08 vip_2020-03-09-03_access.log</span></pre></td></tr></table></figure><p>可以看到分割的日志文件，日志分割也成功。</p>]]></content>
    
    <summary type="html">
    
      使用Docker创建Nginx，并部署Vue项目，同时实现Nginx日志分割
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/categories/Docker/"/>
    
      <category term="Nginx" scheme="http://blog.gaoyp.cn/categories/Docker/Nginx/"/>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/tags/Docker/"/>
    
      <category term="Nginx" scheme="http://blog.gaoyp.cn/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>数据库锁机制</title>
    <link href="http://blog.gaoyp.cn/2020/03/01/database-lock/"/>
    <id>http://blog.gaoyp.cn/2020/03/01/database-lock/</id>
    <published>2020-03-01T11:38:42.000Z</published>
    <updated>2020-03-01T14:07:17.909Z</updated>
    
    <content type="html"><![CDATA[<h2 id="数据库引擎"><a href="#数据库引擎" class="headerlink" title="数据库引擎"></a>数据库引擎</h2><p>mysql常见的数据库引擎有MyISAM、InnoDB。<br>MySQL中myisam与innodb的区别：</p><ul><li>InnoDB支持事物，而MyISAM不支持事物</li><li>InnoDB支持行级锁，而MyISAM支持表级锁</li><li>InnoDB支持外键，而MyISAM不支持</li><li>InnoDB提供提交、回滚、崩溃恢复能力的事务安全（ASID）能力，实现并发控制。</li><li>MyISAM提供较高的插入和查询记录的效率，主要用于插入和查询。</li></ul><h2 id="数据库锁分类"><a href="#数据库锁分类" class="headerlink" title="数据库锁分类"></a>数据库锁分类</h2><h3 id="乐观锁和悲观锁概念"><a href="#乐观锁和悲观锁概念" class="headerlink" title="乐观锁和悲观锁概念"></a>乐观锁和悲观锁概念</h3><p>悲观锁：总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会阻塞直到它拿到锁。<br>乐观锁：每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。</p><p>共享锁和排他锁都是悲观锁的实现方式，由数据库提供。乐观锁就需要自己实现了。</p><h3 id="操作粒度分类"><a href="#操作粒度分类" class="headerlink" title="操作粒度分类"></a>操作粒度分类</h3><ul><li>表锁 ：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。</li><li>行锁 ：开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</li><li>页锁（不常见） ：开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般</li></ul><h4 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h4><ol><li><p>查看数据库每张表使用表锁的情况：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysql&gt; show open tables;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">+--------------------+------------------------------------------------------+--------+-------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">| Database           | Table                                                | In_use | Name_locked |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">+--------------------+------------------------------------------------------+--------+-------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">| vim-base           | user_role_bak_190902                                 |      0 |           0 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">| performance_schema | status_by_user                                       |      0 |           0 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">| febs_cloud_base    | zipkin_spans                                         |      0 |           0 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">| vim-wmi            | vin_group                                            |      0 |           0 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">| vim-base           | enterprise_update                                    |      0 |           0 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">| vim-wmi            | wmi_detail                                           |      0 |           0 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">| performance_schema | events_stages_summary_by_host_by_event_name          |      0 |           0 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">+--------------------+------------------------------------------------------+--------+-------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">323 rows in set (0.20 sec)</span></pre></td></tr></table></figure><p>In_use 为1 代表使用了锁。</p></li><li><p>表锁命令：</p></li></ol><ul><li>加锁 lock table &lt;tableName&gt; read|write;</li><li>解锁 unlock tables;</li></ul><ol start="3"><li><p>以下是MyISAM表锁的总结：<br><img src="/images/database/table-lock.png" alt="table-lock.png"></p></li><li><p>分析数据库表锁定</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysql&gt; show status like &#39;table%&#39;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">+----------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">| Variable_name              | Value |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">+----------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">| Table_locks_immediate      | 340   |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">| Table_locks_waited         | 0     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">| Table_open_cache_hits      | 22    |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">| Table_open_cache_misses    | 1     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">| Table_open_cache_overflows | 0     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">+----------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">5 rows in set (0.02 sec)</span></pre></td></tr></table></figure></li></ol><ul><li>Table_locks_immediate：产生表级锁定的次数，表示可以立即获取锁的次数。</li><li>Table_locks_waited：产生表级锁定争用二发生等待的次数，次数愈多，表明表级锁争用情况越严重。</li></ul><h4 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h4><p>Innodb 引擎，默认是行锁。</p><p>注意：行锁是依赖索引的，如果没有索引或者索引失效，则会自动转为表锁。</p><ol><li>间隙锁<br><img src="/images/database/next-key.png" alt="next-key.png"></li></ol><h3 id="操作类型分类"><a href="#操作类型分类" class="headerlink" title="操作类型分类"></a>操作类型分类</h3><h4 id="共享锁（S锁、读锁）"><a href="#共享锁（S锁、读锁）" class="headerlink" title="共享锁（S锁、读锁）"></a>共享锁（S锁、读锁）</h4><p>对同一数据，多个读操作可同时进行。但是会阻塞其他进程的写操作。</p><h4 id="排他锁（X锁、写锁）"><a href="#排他锁（X锁、写锁）" class="headerlink" title="排他锁（X锁、写锁）"></a>排他锁（X锁、写锁）</h4><p>当前写操作没完成前，阻断其他进程的读和写操作。</p><ol><li><p>查看数据库表锁情况</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysql&gt; show status like &#39;innodb_row_lock%&#39;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">+-------------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">| Variable_name                 | Value |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">+-------------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">| Innodb_row_lock_current_waits | 0     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">| Innodb_row_lock_time          | 2     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">| Innodb_row_lock_time_avg      | 2     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">| Innodb_row_lock_time_max      | 2     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">| Innodb_row_lock_waits         | 1     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">+-------------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">5 rows in set (0.02 sec)</span></pre></td></tr></table></figure><p><img src="/images/database/hang-lock.png" alt="hang-lock.png"></p></li><li><p>语法：<br>共享锁：SQL+ lock in share mode;<br>排它锁：SQL+ for update;</p></li></ol><h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>所谓死锁：是指两个或两个以上的进程在执行过程中，因争夺资源而造成的一种互相等待的现象，若无外力作用，它们都将无法推进下去。此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程。</p><p>产生死锁的四个必要条件：</p><ul><li>互斥条件：一个资源每次只能被一个进程使用。</li><li>请求与保持条件：一个进程因请求资源而阻塞时，对已获得的资源保持不放。</li><li>不剥夺条件:进程已获得的资源，在末使用完之前，不能强行剥夺。</li><li>循环等待条件:若干进程之间形成一种头尾相接的循环等待资源关系。</li></ul><p>这四个条件是死锁的必要条件，只要系统发生死锁，这些条件必然成立，而只要上述条件之一不满足，就不会发生死锁。</p>]]></content>
    
    <summary type="html">
    
      数据库锁机制
    
    </summary>
    
    
      <category term="数据库" scheme="http://blog.gaoyp.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/"/>
    
    
      <category term="数据库" scheme="http://blog.gaoyp.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>SQL 调优</title>
    <link href="http://blog.gaoyp.cn/2020/03/01/database-sql-better/"/>
    <id>http://blog.gaoyp.cn/2020/03/01/database-sql-better/</id>
    <published>2020-03-01T08:37:15.000Z</published>
    <updated>2020-03-01T11:11:01.928Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SQL优化方式"><a href="#SQL优化方式" class="headerlink" title="SQL优化方式"></a>SQL优化方式</h2><h3 id="小表驱动大表"><a href="#小表驱动大表" class="headerlink" title="小表驱动大表"></a>小表驱动大表</h3><p><img src="/images/database/sql-exist.png" alt="sql-exist.png"></p><h3 id="Order-by-优化"><a href="#Order-by-优化" class="headerlink" title="Order by 优化"></a>Order by 优化</h3><ul><li>Order by 语句应该符合最佳左前缀原则。尽可能在索引列上完成排序<br>eg:<br>索引：index  idx_n_a(name,age)<br>select name,age from user age&gt;20 order by name,age (√)<br>select name,age from user age&gt;20 order by name     (√)<br>select name,age from user age&gt;20 order by age      (×)<br>select name,age from user age&gt;20 order by age,name (×)</li></ul><p>注意，当索引idx_n_a的第一个列 name为常量时，order by age也可以使用索引<br>select name,age from user age=20 order by age      (√)</p><ul><li>使用Order by 时最好不要使用select * ，使用select colume1,colume2,….from table Order by colume1，colume2…</li><li>使用Order by 查询慢，可以尝试提高系统参数 sort_buffer_size 的值</li><li>使用Order by 查询慢，可以尝试提高系统参数 max_length_for_sort_data 的值</li></ul><h3 id="group-by-优化"><a href="#group-by-优化" class="headerlink" title="group by 优化"></a>group by 优化</h3><p>与order by 的优化方式基本一致。主要注意的点：</p><ul><li>group by先排序后分组，符合最佳左前缀原则</li><li>能使用where限定条件，就不要使用having</li></ul><p>Having与Where的区别</p><ol><li>where 子句的作用是在对查询结果进行分组前，将不符合where条件的行去掉，即在分组之前过滤数据，where条件中不能包含聚组函数，使用where条件过滤出特定的行。</li><li>having 子句的作用是筛选满足条件的组，即在分组之后过滤数据，条件中经常包含聚组函数，使用having 条件过滤出特定的组，也可以使用多个分组标准进行分组。</li></ol><h3 id="开启慢查询日志"><a href="#开启慢查询日志" class="headerlink" title="开启慢查询日志"></a>开启慢查询日志</h3><p>慢查询日志默认不开启(影响性能，需要时开启即可)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;%slow_query_log%&#39;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">+---------------------+--------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">| Variable_name       | Value                    |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">+---------------------+--------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">| slow_query_log      | ON                       |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">| slow_query_log_file | WIN-03C6PBEDETT-slow.log |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">+---------------------+--------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">2 rows in set (0.06 sec)</span></pre></td></tr></table></figure><p>开启命令(只对当前数据库有效，重启数据库则失效)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysql&gt; set global slow_query_log&#x3D;1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Query OK, 0 rows affected (0.00 sec)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;%slow_query_log%&#39;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">+---------------------+--------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">| Variable_name       | Value                    |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">+---------------------+--------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">| slow_query_log      | ON                       |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">| slow_query_log_file | WIN-03C6PBEDETT-slow.log |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">+---------------------+--------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">2 rows in set (0.01 sec)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;%long_query_time%&#39;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">+-----------------+-----------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">| Variable_name   | Value     |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">+-----------------+-----------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">| long_query_time | 10.000000 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">+-----------------+-----------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">1 row in set (0.01 sec)</span></pre></td></tr></table></figure><p>上面我们开启了慢查询日志，把查询时间超过10秒的记录到WIN-03C6PBEDETT-slow.log(这是windows环境，Linux下slow_query_log_file会指明慢查询文件路径)中。<br>我们也可以修改 long_query_time 值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">set global long_query_time&#x3D;3;</span></pre></td></tr></table></figure><p>我们可以使用mysqldumpslow 分析日志文件。语法：mysqldumpslow 参数 日志文件。<br>eg ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s r -t 10 WIN-03C6PBEDETT-slow.log</span></pre></td></tr></table></figure><p>参数列表：<br><img src="/images/database/mysqldumpslow.png" alt="mysqldumpslow.png"></p><h3 id="Show-Profile-sql分析"><a href="#Show-Profile-sql分析" class="headerlink" title="Show Profile sql分析"></a>Show Profile sql分析</h3><p>开启功能</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;%profiling%&#39;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">+------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">| Variable_name          | Value |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">+------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">| have_profiling         | YES   |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">| profiling              | OFF   |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">| profiling_history_size | 15    |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">+------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">3 rows in set (0.02 sec)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">mysql&gt; set profiling&#x3D;1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">Query OK, 0 rows affected (0.01 sec)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;%profiling%&#39;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">+------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">| Variable_name          | Value |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">+------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">| have_profiling         | YES   |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">| profiling              | ON    |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">| profiling_history_size | 15    |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">+------------------------+-------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">3 rows in set (0.03 sec)</span></pre></td></tr></table></figure><p>查看使用过的SQL,其中Duration显示执行时间</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysql&gt; show profiles;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">+----------+------------+-----------------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">| Query_ID | Duration   | Query                             |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">+----------+------------+-----------------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">|        1 | 0.00210800 | show variables like &#39;%profiling%&#39; |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">|        2 | 0.00064725 | select * from user                |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">|        3 | 0.01892075 | select * from wmi                 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">+----------+------------+-----------------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">3 rows in set (0.02 sec)</span></pre></td></tr></table></figure><p>查看SQL执行过程，语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">show profile &lt;type&gt; for query &lt;Query_ID&gt;;</span></pre></td></tr></table></figure><p>可用type参数列表<br><img src="/images/database/show-profiles-type.png" alt="show-profiles-type.png"></p><p>eg:查看Query_ID为3的SQL的cpu及io耗时</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysql&gt; show profile cpu,block io for query 3;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">+----------------------+----------+----------+------------+--------------+---------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">| Status               | Duration | CPU_user | CPU_system | Block_ops_in | Block_ops_out |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">+----------------------+----------+----------+------------+--------------+---------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">| starting             | 0.000049 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">| checking permissions | 0.000025 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">| Opening tables       | 0.000022 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">| init                 | 0.000062 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">| System lock          | 0.000033 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">| optimizing           | 0.000005 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">| statistics           | 0.000016 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">| preparing            | 0.000012 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">| executing            | 0.000003 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">| Sending data         | 0.018619 | 0.015625 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">| end                  | 0.000008 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">| query end            | 0.000007 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">| closing tables       | 0.000008 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">| freeing items        | 0.000025 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">| cleaning up          | 0.000030 | 0.000000 | 0.000000   | NULL         | NULL          |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">+----------------------+----------+----------+------------+--------------+---------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">15 rows in set (0.03 sec)</span></pre></td></tr></table></figure><p>我们需要注意Status列是否会出现如下内容：</p><p><img src="/images/database/show-profiles-status.png" alt="show-profiles-status.png"></p>]]></content>
    
    <summary type="html">
    
      SQL 调优
    
    </summary>
    
    
      <category term="数据库" scheme="http://blog.gaoyp.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/"/>
    
    
      <category term="数据库" scheme="http://blog.gaoyp.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/tags/Mysql/"/>
    
      <category term="sql调优" scheme="http://blog.gaoyp.cn/tags/sql%E8%B0%83%E4%BC%98/"/>
    
  </entry>
  
  <entry>
    <title>SQL join的使用</title>
    <link href="http://blog.gaoyp.cn/2020/03/01/database-sql-join/"/>
    <id>http://blog.gaoyp.cn/2020/03/01/database-sql-join/</id>
    <published>2020-03-01T02:52:25.000Z</published>
    <updated>2020-03-01T08:38:17.062Z</updated>
    
    <content type="html"><![CDATA[<p>SQL中JOIN的常规使用示意图：<br><img src="/images/database/sql-join.png" alt="sql-join.png"></p>]]></content>
    
    <summary type="html">
    
      SQL join的使用
    
    </summary>
    
    
      <category term="数据库" scheme="http://blog.gaoyp.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/"/>
    
    
      <category term="数据库" scheme="http://blog.gaoyp.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>使用explain对sql语句进行性能分析</title>
    <link href="http://blog.gaoyp.cn/2020/02/29/database-explain/"/>
    <id>http://blog.gaoyp.cn/2020/02/29/database-explain/</id>
    <published>2020-02-29T12:21:19.000Z</published>
    <updated>2020-02-29T14:55:12.813Z</updated>
    
    <content type="html"><![CDATA[<div class="note info">            <p>在日常工作中，我们有时会遇到一些慢查询的情况，些时我们常常用到explain这个命令来查看一个这些SQL语句的执行计划，查看该SQL语句有没有使用上了索引，有没有做全表扫描等。</p><p>这都可以通过explain命令来查看。所以我们深入了解MySQL的基于开销的优化器，还可以获得很多可能被优化器考虑到的访问策略的细节，以及当运行SQL语句时哪种策略预计会被优化器采用。</p>          </div><h2 id="可以干嘛"><a href="#可以干嘛" class="headerlink" title="可以干嘛"></a>可以干嘛</h2><p>使用explain分析sql,我们可以分析出以下结果：</p><ul><li>表的读取顺序</li><li>数据读取操作的操作类型</li><li>哪些索引可以使用</li><li>哪些索引被实际使用</li><li>表之间的引用</li><li>每张表有多少行被优化器查询</li></ul><h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysql&gt; select version();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">+------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">| version()  |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">+------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">| 5.7.17-log |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">+------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">1 row in set (0.02 sec)</span></pre></td></tr></table></figure><h2 id="怎么用"><a href="#怎么用" class="headerlink" title="怎么用"></a>怎么用</h2><p>格式：explain + sql （命令行界面）</p><p>我们来查看一个explain的使用示例(正好写了一个sql,拿来分析一下)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mysql&gt; explain SELECT</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"> w.id &#39;ID&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"> w.application_code &#39;申请号码&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"> w.enterprise_id &#39;企业ID&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> w.enterprise_name &#39;企业名称&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"> w.wmi_code &#39;wmi编码&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"> w.vin_id &#39;VINID&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"> w.&#96;status&#96; &#39;状态&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"> w.origin_id &#39;原始ID&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> w.type &#39;类型&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"> w.certificate_no &#39;证书编号&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"> d.certificate_start &#39;原证书开始时间&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"> d.certificate_end &#39;原证书结束时间&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"> w.certificate_start &#39;开始时间&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"> w.certificate_end &#39;结束时间&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"> w.deferred_state &#39;证书延期状态&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"> w.created_at &#39;创建时间&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"> w.update_at &#39;修改时间&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"> w.submitted_at &#39;提交时间&#39;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"> w.created_by &#39;创建人ID&#39; </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">FROM</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"> &#96;vim-wmi&#96;.wmi w ,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">  (SELECT * FROM ( SELECT id,origin_id,certificate_start,certificate_end FROM &#96;vim-wmi&#96;.wmi WHERE &#96;status&#96; &#x3D; 12 ) b) d</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">WHERE</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"> w.origin_id IN ( SELECT * FROM ( SELECT id FROM &#96;vim-wmi&#96;.wmi WHERE &#96;status&#96; &#x3D; 12 ) a ) </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"> AND w.&#96;status&#96;  IN (9,12 ) and w.origin_id &#x3D; d.id AND w.type &#x3D; 383;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">+----+-------------+-------+------------+--------+---------------+---------+---------+---------------------+------+----------+-------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref                 | rows | filtered | Extra       |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">+----+-------------+-------+------------+--------+---------------+---------+---------+---------------------+------+----------+-------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">|  1 | SIMPLE      | w     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL                | 2756 |     2.00 | Using where |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">|  1 | SIMPLE      | wmi   | NULL       | eq_ref | PRIMARY       | PRIMARY | 128     | vim-wmi.w.origin_id |    1 |    10.00 | Using where |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">|  1 | SIMPLE      | wmi   | NULL       | eq_ref | PRIMARY       | PRIMARY | 128     | vim-wmi.w.origin_id |    1 |    10.00 | Using where |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">+----+-------------+-------+------------+--------+---------------+---------+---------+---------------------+------+----------+-------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">3 rows in set (0.05 sec)</span></pre></td></tr></table></figure><p>expain 分析出来的信息分别是id、select_type、table、partitions、type、possible_keys、key、key_len、ref、rows、filtered、Extra</p><h3 id="id"><a href="#id" class="headerlink" title="id"></a>id</h3><p>select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</p><p>id的结果共有3种排序情况：</p><ol><li>id 相同，语句执行顺序：顺序执行<br><img src="/images/database/explain_id_1.png" alt="explain_id_1.png"></li></ol><p>加载表的顺序如上图table列所示：t1 t2 t3</p><ol start="2"><li>id 值都不同，id的序号会递增，id值越大优先级越高，越先被执行<br><img src="/images/database/explain_id_2.png" alt="explain_id_1.png"></li></ol><p>加载表的顺序如上图table列所示：t3 t1 t2</p><p>3、id 值有的相同有的不同，id值越大优先级越高，相同值顺序执行<br><img src="/images/database/explain_id_3.png" alt="explain_id_1.png"></p><p>加载表的顺序如上图table列所示：t3 t2 <derived2>，<derived2>是一个衍生表，2即是代表id为2的那一行。</p><h3 id="select-type"><a href="#select-type" class="headerlink" title="select_type"></a>select_type</h3><p>分别用来表示查询的类型，主要是用于区别普通查询、联合查询、子查询等的复杂查询。</p><p>分为如下6种</p><ul><li>SIMPLE：简单的select查询，查询中不包含子查询或者UNION</li><li>PRIMARY：查询中若包含任何复杂的子部分，最外层查询则被标记为PRIMARY</li><li>SUBQUERY：在SELECT或WHERE列表中包含了子查询</li><li>DERIVED：在FROM列表中包含的子查询被标记为DERIVED（衍生），MySQL会递归执行这些子查询，把结果放在临时表中</li><li>UNION：若第二个SELECT出现在UNION之后，则被标记为UNION：若UNION包含在FROM子句的子查询中，外层SELECT将被标记为：DERIVED</li><li>UNION RESULT： 从UNION表获取结果的SELECT</li></ul><h3 id="table"><a href="#table" class="headerlink" title="table"></a>table</h3><p>显示的查询表名，如果查询使用了别名，那么这里显示的是别名，如果不涉及对数据表的操作，那么这显示为null。<br>如果显示为尖括号括起来的<derived N>就表示这个是临时表，后边的N就是执行计划中的id，表示结果来自于这个查询产生。</p><h3 id="partitions"><a href="#partitions" class="headerlink" title="partitions"></a>partitions</h3><p>对分区的说明</p><h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p>type所显示的是查询使用了哪种类型</p><p>从最好到最差依次是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">system，const，eq_ref，ref，fulltext，ref_or_null，index_merge，unique_subquery，index_subquery，range，index，ALL</span></pre></td></tr></table></figure><p>一般来说，得保证查询至少达到range级别，最好能达到ref。</p><p>介绍几个经常见到的：</p><ul><li>system 表只有一行记录（等于系统表），这是const类型的特列，平时不会出现，这个也可以忽略不计</li><li>const 表示通过索引一次就找到了,const用于比较primary key 或者unique索引。因为只匹配一行数据，所以很快。</li><li>eq_ref 唯一性索引扫描，对于每个索引键，表中只有一条记录与之匹配。常见于主键或唯一索引扫描.</li><li>ref 非唯一性索引扫描，我理解为用过索引找到了符合查询条件的多条结果</li><li>range 只检索给定范围的行，一般就是在你的where语句中出现between、&lt; 、&gt;、in等的查询，这种范围扫描索引比全表扫描要好，因为它只需要开始于索引的某一点，而结束于另一点，不用扫描全部索引。</li><li>index Index与All区别为index类型只遍历索引树。这通常比ALL快，因为索引文件通常比数据文件小。（全索引遍历）</li><li>all 将遍历全表以找到匹配的行</li></ul><h3 id="possible-keys-和-key"><a href="#possible-keys-和-key" class="headerlink" title="possible_keys 和 key"></a>possible_keys 和 key</h3><ul><li>possible_keys：显示可能应用在这张表中的索引，一个或多个。查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询实际使用。</li><li>key：实际使用的索引，如果为NULL，则没有使用索引。（可能原因包括没有建立索引或索引失效），查询中若使用了覆盖索引（select 后要查询的字段刚好和创建的索引字段完全相同），则该索引仅出现在key列表中</li></ul><h3 id="key-len"><a href="#key-len" class="headerlink" title="key_len"></a>key_len</h3><p>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度，在不损失精确性的情况下，长度越短越好。<br>key_len显示的值为索引字段的最大可能长度，并非实际使用长度，即key_len是根据表定义计算而得，不是通过表内检索出的。</p><p>同样查询结果，key_len越小越好。</p><h3 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h3><p>显示索引的那一列被使用了，或哪一个常量被用于查找索引列上的值。</p><h3 id="rows"><a href="#rows" class="headerlink" title="rows"></a>rows</h3><p>这里是执行计划中估算的扫描行数，不是精确值。越少越好</p><h3 id="filtered"><a href="#filtered" class="headerlink" title="filtered"></a>filtered</h3><p>指返回结果的行占需要读到的行(rows列的值)的百分比</p><h3 id="Extra"><a href="#Extra" class="headerlink" title="Extra"></a>Extra</h3><p>这里显示些其他的信息。要注意extra辅助信息中的using filesort和using temporary，这两项非常消耗性能，需要注意。</p><p>这个列可以显示的信息非常多，有几十种，常用的有：</p><ul><li>distinct：在select部分使用了distinc关键字</li><li>no tables used：不带from字句的查询或者From dual查询</li><li>使用not in()形式子查询或not exists运算符的连接查询，这种叫做反连接。即，一般连接查询是先查询内表，再查询外表，反连接就是先查询外表，再查询内表。</li><li>using filesort：排序时无法使用到索引时，就会出现这个。常见于order by和group by语句中</li><li>using index：查询时不需要回表查询，直接通过索引就可以获取查询的数据。（说明效率高）</li><li>using join buffer（block nested loop），using join buffer（batched key accss）：5.6.x之后的版本优化关联查询的BNL，BKA特性。主要是减少内表的循环数量以及比较顺序地扫描查询。</li><li>using sort_union，using_union，using intersect，using sort_intersection：</li><li>using intersect：表示使用and的各个索引的条件时，该信息表示是从处理结果获取交集</li><li>using union：表示使用or连接各个使用索引的条件时，该信息表示从处理结果获取并集</li><li>using sort_union和using sort_intersection：与前面两个对应的类似，只是他们是出现在用and和or查询信息量大时，先查询主键，然后进行排序合并后，才能读取记录并返回。</li><li>using temporary：表示使用了临时表存储中间结果。临时表可以是内存临时表和磁盘临时表，执行计划中看不出来，需要查看status变量，used_tmp_table，used_tmp_disk_table才能看出来。</li><li>using where：表示存储引擎返回的记录并不是所有的都满足查询条件，需要在server层进行过滤。查询条件中分为限制条件和检查条件，5.6之前，存储引擎只能根据限制条件扫描数据并返回，然后server层根据检查条件进行过滤再返回真正符合查询的数据。5.6.x之后支持ICP特性，可以把检查条件也下推到存储引擎层，不符合检查条件和限制条件的数据，直接不读取，这样就大大减少了存储引擎扫描的记录数量。extra列显示using index condition</li><li>firstmatch(tb_name)：5.6.x开始引入的优化子查询的新特性之一，常见于where字句含有in()类型的子查询。如果内表的数据量比较大，就可能出现这个</li><li>loosescan(m..n)：5.6.x之后引入的优化子查询的新特性之一，在in()类型的子查询中，子查询返回的可能有重复记录时，就可能出现这个</li></ul><p>除了这些之外，还有很多查询数据字典库，执行计划过程中就发现不可能存在结果的一些提示信息</p>]]></content>
    
    <summary type="html">
    
      使用explain对sql语句进行性能分析
    
    </summary>
    
    
      <category term="数据库" scheme="http://blog.gaoyp.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/"/>
    
    
      <category term="数据库" scheme="http://blog.gaoyp.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>数据库索引</title>
    <link href="http://blog.gaoyp.cn/2020/02/27/database-index-01/"/>
    <id>http://blog.gaoyp.cn/2020/02/27/database-index-01/</id>
    <published>2020-02-26T16:08:15.000Z</published>
    <updated>2020-03-01T08:54:23.653Z</updated>
    
    <content type="html"><![CDATA[<div class="note info">            <p>MySQL官方对索引的定义为：索引（Index）是帮助MySQL高效获取数据的数据结构。即索引的本质：索引是数据结构。<br>但方法都是有利有弊，索引在方便你查询的时候，也要牺牲磁盘的空间为代价。<br>数据库索引可以协助快速查询,更新数据库中表的数据.索引的实现通常使用B树和变种的B+树(mysql常用的索引就是B+树)</p>          </div><h2 id="索引结构分类"><a href="#索引结构分类" class="headerlink" title="索引结构分类"></a>索引结构分类</h2><p>Mysql目前主要有以下几种索引结构：HASH，BTREE，RTREE</p><ul><li><p>BTREE<br>BTREE索引就是一种将索引值按一定的算法，存入一个树形的数据结构中（二叉树），每次查询都是从树的入口root开始，依次遍历node，获取leaf。<br><label style="color:red">BTREE是MySQL里默认和最常用的索引类型</label></p></li><li><p>HASH<br>由于HASH的唯一（几乎100%的唯一）及类似键值对的形式，很适合作为索引。<br>HASH索引可以一次定位，不需要像树形索引那样逐层查找,因此具有极高的效率。但是，这种高效是有条件的，即只在“=”和“in”条件下高效，对于范围查询、排序及组合索引仍然效率不高。</p></li><li><p>RTREE<br>RTREE在MySQL很少使用，仅支持geometry数据类型，支持该类型的存储引擎只有MyISAM、BDb、InnoDb、NDb、Archive几种。<br>相对于BTREE，RTREE的优势在于范围查找。</p></li></ul><h2 id="索引类型"><a href="#索引类型" class="headerlink" title="索引类型"></a>索引类型</h2><p>mysql 索引有2种分类标准</p><ol><li>从物理存储角度分为：聚簇索引、非聚簇索引</li><li>从逻辑存储角度分为：普通索引、唯一索引、主键索引、组合索引、全文索引</li></ol><h3 id="聚簇索引和非聚簇索引"><a href="#聚簇索引和非聚簇索引" class="headerlink" title="聚簇索引和非聚簇索引"></a>聚簇索引和非聚簇索引</h3><ul><li><p>聚簇索引：是对磁盘上实际数据重新组织以按指定的一个或多个列的值排序的算法。特点是存储数据的顺序和索引顺序一致。<br><label style="color:red">一个表只能有一个聚簇索引。主键索引一般都是聚簇索引</label></p></li><li><p>非聚簇索引：表数据存储顺序与索引顺序无关。对于非聚簇索引，叶结点包含索引字段值及指向数据页数据行的逻辑指针，其行数量与数据表行数据量一致。非聚簇索引记录的物理顺序与逻辑顺序没有必然的联系，与数据的存储物理结构没有关系；一个表对应的非聚簇索引可以有多条，根据不同列的约束可以建立不同要求的非聚簇索引；</p></li></ul><p>建立聚簇索引的语句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">CREATE CLUSTER INDEX index_name ON table_name(column_name1,...);</span></pre></td></tr></table></figure><h4 id="聚簇索引-VS-非聚簇索引"><a href="#聚簇索引-VS-非聚簇索引" class="headerlink" title="聚簇索引 VS 非聚簇索引"></a>聚簇索引 VS 非聚簇索引</h4><ul><li>聚簇索引的叶子节点就是数据节点（Innodb的B+树的主键对应的数据节点），非聚簇索引的叶子节点仍然是索引节点，只不过有指向对应数据块的指针。</li><li>聚簇索引主键的插入速度要比非聚簇索引主键的插入速度慢很多。聚簇索引适合排序，非聚簇索引不适合用在排序的场合。因为聚簇索引本身已经是按照物理顺序放置的，排序很快。非聚簇索引则没有按序存放，需要额外消耗资源来排序。</li></ul><h3 id="普通索引、唯一索引、主键索引、组合索引、全文索引"><a href="#普通索引、唯一索引、主键索引、组合索引、全文索引" class="headerlink" title="普通索引、唯一索引、主键索引、组合索引、全文索引"></a>普通索引、唯一索引、主键索引、组合索引、全文索引</h3><h4 id="普通索引（NORMAL）"><a href="#普通索引（NORMAL）" class="headerlink" title="普通索引（NORMAL）"></a>普通索引（NORMAL）</h4><blockquote><p>仅加速查询,无限制</p></blockquote><h4 id="唯一索引（UNIQUE）"><a href="#唯一索引（UNIQUE）" class="headerlink" title="唯一索引（UNIQUE）"></a>唯一索引（UNIQUE）</h4><blockquote><p>加速查询 + 列值唯一（可以有null）,如果是组合索引，则列值的组合必须唯一</p></blockquote><h4 id="主键索引-PRIMARY-KEY"><a href="#主键索引-PRIMARY-KEY" class="headerlink" title="主键索引 (PRIMARY KEY)"></a>主键索引 (PRIMARY KEY)</h4><blockquote><p>加速查询 + 列值唯一（不可以有null）+ 表中只允许有一个主键索引, 是一种特殊的唯一索引</p></blockquote><h4 id="组合索引"><a href="#组合索引" class="headerlink" title="组合索引"></a>组合索引</h4><blockquote><p>多列值组成一个索引，专门用于组合搜索，其效率大于索引合并（索引合并：使用多个单列索引组合搜索）<br>只有在查询条件中使用了创建索引时的第一个字段，索引才会被使用。使用组合索引时遵循最左前缀集合</p></blockquote><p>eg: 我们新建一张表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">CREATE TABLE mytable( ID INT NOT NULL, username VARCHAR(16) NOT NULL, city VARCHAR(50) NOT NULL, age INT NOT NULL );</span></pre></td></tr></table></figure><p>为了进一步榨取MySQL的效率，就要考虑建立组合索引。就是将 name, city, age建到一个索引里：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ALTER TABLE mytable ADD INDEX name_city_age (name(10),city,age);</span></pre></td></tr></table></figure><p>建表时，usernname长度为 16，这里用 10。这是因为一般情况下名字的长度不会超过10，这样会加速索引查询速度，还会减少索引文件的大小，提高INSERT的更新速度。<br>如果分别在 usernname，city，age上建立单列索引，让该表有3个单列索引，查询时和上述的组合索引效率也会大不一样，远远低于我们的组合索引。虽然此时有了三个索引，但MySQL只能用到其中的那个它认为似乎是最有效率的单列索引。</p><p>建立这样的组合索引，其实是相当于分别建立了下面三组组合MySQL数据库索引：</p><ol><li>usernname,city,age</li><li>usernname,city</li><li>usernname </li></ol><p>为什么没有 city，age这样的组合索引呢？这是因为MySQL组合索引“最左前缀”的结果。简单的理解就是只从最左面的开始组合。并不是只要包含这三列的查询都会用到该组合索引，下面的几个SQL就会用到这个组合MySQL数据库索引：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">SELECT * FROM mytable WHREE username&#x3D;&quot;admin&quot; AND city&#x3D;&quot;郑州&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">SELECT * FROM mytable WHREE username&#x3D;&quot;admin&quot;</span></pre></td></tr></table></figure><p>而下面几个则不会用到：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">SELECT * FROM mytable WHREE age&#x3D;20 AND city&#x3D;&quot;郑州&quot; </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">SELECT * FROM mytable WHREE city&#x3D;&quot;郑州&quot;</span></pre></td></tr></table></figure><h4 id="全文索引-FULLTEXT"><a href="#全文索引-FULLTEXT" class="headerlink" title="全文索引 (FULLTEXT)"></a>全文索引 (FULLTEXT)</h4><blockquote><p>它能够利用【分词技术】等多种算法智能分析出文本文字中关键词的频率和重要性，然后按照一定的算法规则智能地筛选出我们想要的搜索结果。</p></blockquote><p>全文索引，以前只有MyISAM引擎支持。Mysql5.6后开始默认使用InnoDb引擎，并且5.6.4版本后的InnoDb引擎开始支持全文索引。<br>目前只有 CHAR、VARCHAR 、TEXT 列上可以创建全文索引。</p><p>select * from article where content like ‘%xxx%’;这种写法查询效率非常低。全文索引就是为了高效的解决这种问题产生的。</p><p>具体如何使用全文索引呢？</p><p>不用全文索引时的写法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">SELECT * FROM article WHERE content LIKE &#39;%查询字符串%&#39;;</span></pre></td></tr></table></figure><p>如果我们在content字段建立了全文索引，那么使用全文索引的写法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">SELECT * FROM article WHERE MATCH(title,content) AGAINST (&#39;查询字符串&#39;);</span></pre></td></tr></table></figure><p>注意：在数据量较大时候，我们应该先将数据放入一个没有全局索引的表中，然后再用CREATE index创建fulltext索引，要比先为一张表建立fulltext然后再将数据写入的查询速度快。</p><h4 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h4><blockquote><p>select的数据列只用从索引中就能够取得，不必读取数据行，换句话说查询列要被所建的索引覆盖</p></blockquote><p>例如：<br>表 user 中有一个组合索引 idx_name_sex(name,sex)。<br>当我们通过SQL语句：select name from user where name = ‘garnett’;的时候，就可以通过覆盖索引查询.即查询条件包含在组合索引的列中，换句话说查询的列被索引覆盖。</p><h2 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h2><h3 id="需要建立索引的情况"><a href="#需要建立索引的情况" class="headerlink" title="需要建立索引的情况"></a>需要建立索引的情况</h3><ul><li>主键自动建立主键索引 (PRIMARY KEY)</li><li>频繁作为查询条件的字段</li><li>与其他表关联的字段，外键关系创建索引。（eg：user表中的dept_id）</li><li>查询中统计或者分组的字段</li></ul><h3 id="不适合建立索引的情况"><a href="#不适合建立索引的情况" class="headerlink" title="不适合建立索引的情况"></a>不适合建立索引的情况</h3><ul><li>表记录太少就别建索引了</li><li>频繁更新的字段不要创建索引</li><li>数据列重复的字段不需要创建索引，没必要。（eg：性别字段，不是男就是女）</li><li>对于那些在查询中很少使用或者参考的列不应该创建索引</li></ul><h3 id="join查询索引建立规则"><a href="#join查询索引建立规则" class="headerlink" title="join查询索引建立规则"></a>join查询索引建立规则</h3><ul><li>左连接：右表关联字段建索引</li><li>右连接：左表关联字段建索引</li></ul><h2 id="索引失效情况"><a href="#索引失效情况" class="headerlink" title="索引失效情况"></a>索引失效情况</h2><ul><li><p>条件中有or，即使其中有条件带索引也不会使用(这也是为什么尽量少用or的原因)。注意：要想使用or，又想让索引生效，只能将or条件中的每个列都加上索引</p></li><li><p>在索引字段上使用计算、函数等，会导致索引失效。例如left(name,4),导致name字段索引失效。</p></li><li><p>对于组合索引，如果不使用的组合索引的第一列字段，则不会使用索引（即不符合最左前缀原则）</p></li><li><p>如果列类型是字符串，那一定要在条件中将数据使用引号引用起来,否则不使用索引</p></li><li><p>范围查找，右边的索引全失效。eg:一个组合索引 index（name,age.sex）<br><code>select name,age,sex from where name= &#39;aa&#39; and age &gt;25 and sex=1</code><br>sex 字段上的索引，无法被使用</p></li><li><p>使用 != 和 &lt;&gt; 会导致无法使用索引，变为全表扫描。</p></li><li><p>is null 和 is not null 无法使用索引</p></li><li><p>like ‘%aa’,以通配符开头，索引会失效。针对这种情况，我们可以使用覆盖索引解决。<br>eg: 创建一个组合索引 index（name,age），此时使用 select name from user where name like ‘%aa%’,索引不会失效</p></li></ul><h2 id="查看索引的使用情况"><a href="#查看索引的使用情况" class="headerlink" title="查看索引的使用情况"></a>查看索引的使用情况</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">show status like ‘Handler_read%’;</span></pre></td></tr></table></figure><p><img src="/images/database/handler_read.png" alt="handler_read.png"></p><ul><li>handler_read_key:这个值越高越好，越高表示使用索引查询到的次数越多</li><li>handler_read_rnd_next:这个值越高越不好，说明查询低效</li></ul><p>参考文章：<br><a href="https://www.cnblogs.com/LiLiliang/p/9960895.html" target="_blank" rel="noopener">https://www.cnblogs.com/LiLiliang/p/9960895.html</a><br><a href="https://blog.csdn.net/weixin_34379433/article/details/89745873" target="_blank" rel="noopener">https://blog.csdn.net/weixin_34379433/article/details/89745873</a><br><a href="https://blog.csdn.net/qq_36071795/article/details/83956068" target="_blank" rel="noopener">https://blog.csdn.net/qq_36071795/article/details/83956068</a></p>]]></content>
    
    <summary type="html">
    
      数据库索引
    
    </summary>
    
    
      <category term="数据库" scheme="http://blog.gaoyp.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/"/>
    
    
      <category term="数据库" scheme="http://blog.gaoyp.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/tags/Mysql/"/>
    
      <category term="面试" scheme="http://blog.gaoyp.cn/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>使用docker安装redis哨兵(sentinel)</title>
    <link href="http://blog.gaoyp.cn/2020/02/11/redis-03/"/>
    <id>http://blog.gaoyp.cn/2020/02/11/redis-03/</id>
    <published>2020-02-11T03:27:51.000Z</published>
    <updated>2020-03-09T02:10:11.888Z</updated>
    
    <content type="html"><![CDATA[<p>上一节我们搭建了redis主从模式，实现了redis的主从复制，读写分离。主从模式保证了数据备份，但是发生故障依然需要运维人员施工。为了解决主从模式的弊端，本节我们搭建redis哨兵模式。</p><p>本节我们搭建一主二从三哨兵。</p><h2 id="redis哨兵模式"><a href="#redis哨兵模式" class="headerlink" title="redis哨兵模式"></a>redis哨兵模式</h2><p>sentinel 通常翻译成哨兵，用来监控主从节点的健康情况。客户端连接redis主从的时候，先连接 sentinel，sentinel告诉客户端<font color=red>主redis</font>的地址是多少，然后客户端连接上redis并进行后续的操作。</p><p>当主节点挂掉的时候，客户端就得不到连接了因而报错了，客户端重新向sentinel询问主master的地址，然后客户端得到了<font color=red>新选举出来的主redis</font>。当原来的主机恢复后，会将其作为新主的从机。</p><p>我们直接在上一节的已经搭建好的主从基础上搭建redis哨兵模式，上一节的主从模式节点信息如下：</p><table><thead><tr><th align="left">角色</th><th align="center">端口</th><th align="right">密码</th><th align="right">容器名称</th></tr></thead><tbody><tr><td align="left">master</td><td align="center">6380</td><td align="right">123456</td><td align="right">redis-6380</td></tr><tr><td align="left">slaver</td><td align="center">6381</td><td align="right">123456</td><td align="right">redis-6381</td></tr><tr><td align="left">slaver</td><td align="center">6382</td><td align="right">123456</td><td align="right">redis-6382</td></tr></tbody></table><p>各容器network信心如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"> &quot;Containers&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    &quot;3729ea952faade7c3bf37467f00f8a8c6676b9a98e27a897582272f1edce2087&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        &quot;Name&quot;: &quot;redis-6382&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        &quot;EndpointID&quot;: &quot;95f9a05d2b6d10c13eb3d8df706a2700f33a6704ddda290bc6840676eebc6676&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:14:00:04&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        &quot;IPv4Address&quot;: &quot;172.20.0.4&#x2F;16&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        &quot;IPv6Address&quot;: &quot;&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &quot;a7f4ccfa8e8aa87efb697f3ee5fef686e5138ebb0ad5faac282e7850d8cb176f&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        &quot;Name&quot;: &quot;redis-6380&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        &quot;EndpointID&quot;: &quot;71af5cda52f5026aba9b4040890629d5ca560c2a7208b2bc7f0682a97a19d9bf&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:14:00:02&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        &quot;IPv4Address&quot;: &quot;172.20.0.2&#x2F;16&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        &quot;IPv6Address&quot;: &quot;&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    &quot;ff3d51f269c40912a21b2a8686078d963f292b32d32bce6dad089d9008377a36&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        &quot;Name&quot;: &quot;redis-6381&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        &quot;EndpointID&quot;: &quot;405a1e61ea2afae2fca8b0ce31f6ac83b7c03440668b3f7ec42072a0ebff18e3&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:14:00:03&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        &quot;IPv4Address&quot;: &quot;172.20.0.3&#x2F;16&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        &quot;IPv6Address&quot;: &quot;&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>现在我们约定sentinel哨兵节点信息：</p><table><thead><tr><th align="left">名称</th><th align="center">端口</th></tr></thead><tbody><tr><td align="left">sentinel-26379</td><td align="center">26379</td></tr><tr><td align="left">sentinel-26380</td><td align="center">26380</td></tr><tr><td align="left">sentinel-26381</td><td align="center">26381</td></tr></tbody></table><h3 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26379&#x2F;conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26379&#x2F;data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26380&#x2F;conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26380&#x2F;data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26381&#x2F;conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26381&#x2F;data</span></pre></td></tr></table></figure><p>用来存放3个哨兵的配置文件及日志文件。</p><h3 id="准备sentinel-conf"><a href="#准备sentinel-conf" class="headerlink" title="准备sentinel.conf"></a>准备sentinel.conf</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;download.redis.io&#x2F;redis-stable&#x2F;sentinel.conf</span></pre></td></tr></table></figure><p>将sentinel.conf复制3份，分别存放到这3个目录下，并修改对应内容：</p><ul><li>/usr/local/redis/sentinel/sentinel-26379/conf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">dir &#x2F;data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">logfile &quot;sentinel-26379.log&quot;  # 修改日志文件的路径</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">sentinel monitor mymaster redis-6380 6379 2 # redis-6380表示 master 节点地址，最后一个2表示，两个sentinel判定master被动下线后，就进行failover(故障转移)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">sentinel auth-pass mymaster 123456 # 设置master的密码</span></pre></td></tr></table></figure></li><li>/usr/local/redis/sentinel/sentinel-26380/conf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">dir &#x2F;data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">logfile &quot;sentinel-26380.log&quot;  # 修改日志文件的路径</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">sentinel monitor mymaster redis-6380 6379 2 # redis-6380表示 master 节点地址，最后一个2表示，两个sentinel判定master被动下线后，就进行failover(故障转移)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">sentinel auth-pass mymaster 123456 # 设置master的密码</span></pre></td></tr></table></figure></li><li>/usr/local/redis/sentinel/sentinel-26381/conf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">dir &#x2F;data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">logfile &quot;sentinel-26381.log&quot;  # 修改日志文件的路径</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">sentinel monitor mymaster redis-6380 6379 2 # redis-6380表示 master 节点地址，最后一个2表示，两个sentinel判定master被动下线后，就进行failover(故障转移)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">sentinel auth-pass mymaster 123456 # 设置master的密码</span></pre></td></tr></table></figure></li></ul><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">[root@localhost sentinel]# tree</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">├── sentinel-26379</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">│   ├── conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">│   │   └── sentinel.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">│   └── data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">├── sentinel-26380</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">│   ├── conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">│   │   └── sentinel.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">│   └── data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">└── sentinel-26381</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    ├── conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    │   └── sentinel.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    └── data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">9 directories, 3 files</span></pre></td></tr></table></figure><h3 id="创建sentinel容器"><a href="#创建sentinel容器" class="headerlink" title="创建sentinel容器"></a>创建sentinel容器</h3><p>官网建议设置奇数个哨兵，这样才适合选举机制。<br>我们逐个执行下面的启动命令，并查看sentinel.conf文件的变化。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 26379:26379 --name sentinel-26379 --net&#x3D;redis-master-slaver \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26379&#x2F;conf&#x2F;sentinel.conf:&#x2F;etc&#x2F;redis&#x2F;sentinel.conf \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26379&#x2F;data:&#x2F;data redis:5.0.7 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">redis-sentinel &#x2F;etc&#x2F;redis&#x2F;sentinel.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 26380:26379 --name sentinel-26380 --net&#x3D;redis-master-slaver \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26380&#x2F;conf&#x2F;sentinel.conf:&#x2F;etc&#x2F;redis&#x2F;sentinel.conf \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26380&#x2F;data:&#x2F;data redis:5.0.7 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">redis-sentinel &#x2F;etc&#x2F;redis&#x2F;sentinel.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 26381:26379 --name sentinel-26381 --net&#x3D;redis-master-slaver \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26381&#x2F;conf&#x2F;sentinel.conf:&#x2F;etc&#x2F;redis&#x2F;sentinel.conf \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&#x2F;sentinel-26381&#x2F;data:&#x2F;data redis:5.0.7 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">redis-sentinel &#x2F;etc&#x2F;redis&#x2F;sentinel.conf</span></pre></td></tr></table></figure><p>我们启动sentinel-26379后，查看/usr/local/redis/sentinel/sentinel-26379/conf/sentinel.conf文件，有了这些变化：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sentinel myid 327716021d2b88790338b362173a34163a855e56</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">sentinel deny-scripts-reconfig yes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">sentinel monitor mymaster 172.20.0.2 6379 2  #自动替换成了redis-6380的ip</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">sentinel config-epoch mymaster 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">sentinel leader-epoch mymaster 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"># Generated by CONFIG REWRITE</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">sentinel known-replica mymaster 172.20.0.4 6379</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">sentinel known-replica mymaster 172.20.0.3 6379</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">sentinel current-epoch 0</span></pre></td></tr></table></figure><p>日志文件（/usr/local/redis/sentinel/sentinel-26379/data/sentinel-26379.log）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">[root@localhost data]# vim sentinel-26379.log </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:03:09.681 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:03:09.681 # Redis version&#x3D;5.0.7, bits&#x3D;64, commit&#x3D;00000000, modified&#x3D;0, pid&#x3D;1, just started</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:03:09.681 # Configuration loaded</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:03:09.683 * Running mode&#x3D;sentinel, port&#x3D;26379.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:03:09.683 # WARNING: The TCP backlog setting of 511 cannot be enforced because &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn is set to the lower value of 128.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:03:09.687 # Sentinel ID is 327716021d2b88790338b362173a34163a855e56</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:03:09.687 # +monitor master mymaster 172.20.0.2 6379 quorum 2</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:03:09.689 * +slave slave 172.20.0.3:6379 172.20.0.3 6379 @ mymaster 172.20.0.2 6379</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:03:09.690 * +slave slave 172.20.0.4:6379 172.20.0.4 6379 @ mymaster 172.20.0.2 6379</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:06:10.373 * +fix-slave-config slave 172.20.0.4:6379 172.20.0.4 6379 @ mymaster 172.20.0.2 6379</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">1:X 12 Feb 2020 03:06:10.374 * +fix-slave-config slave 172.20.0.3:6379 172.20.0.3 6379 @ mymaster 172.20.0.2 6379</span></pre></td></tr></table></figure><p>可以看到它已经检测到了master和2个slave.</p><p>我们接下来启动sentinel-26380和sentinel-26381，查看/usr/local/redis/sentinel/sentinel-26379/conf/sentinel.conf文件,新增了2行记录，表示监测到了新的哨兵</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sentinel known-sentinel mymaster 172.20.0.7 26379 90137df24fb27cb5821c3a3372c2101379b75018</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">sentinel known-sentinel mymaster 172.20.0.6 26379 d88c61fe5d93be0aaaaff6629196f0034683bb58</span></pre></td></tr></table></figure><h3 id="验证效果"><a href="#验证效果" class="headerlink" title="验证效果"></a>验证效果</h3><p>此时master节点是redis-6380<br><img src="/images/redis/sentinel-master-6380.png" alt="sentinel-master-6380.png"></p><p>我们关掉redis-6380，模式master节点故障情况。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker stop redis-6380</span></pre></td></tr></table></figure><p>我们查看日志sentinel-26379.log<br><img src="/images/redis/sentinel-new-master-log.png" alt="sentinel-new-master-log.png"></p><p>我们可以看到选举过程，现在选定了172.20.0.4这个节点为新的master，即redis-6382,我们来验证一下：<br><img src="/images/redis/sentinel-new-master.png" alt="sentinel-new-master.png"></p><p>可以看到符合我们的预期。</p><p>此时我们再次启动redis-6380,并查看redis-6380信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker start redis-6380</span></pre></td></tr></table></figure><p><img src="/images/redis/sentinel-failer-link-master.png" alt="sentinel-failer-link-master.png"></p><p>可以看到，redis-6380变为了slave,但是没有连接上新的master。</p><p>这是因为我们在上一节主从模式时，在redis-6380的redis.conf中未配置密码的原因。<br>修改/usr/local/redis/master-slaver/master/conf/redis.conf,添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">masterauth 123456</span></pre></td></tr></table></figure><p>我们重启redis-6380,并查看redis-6380信息<br><img src="/images/redis/sentinel-success-link-master.png" alt="sentinel-success-link-master.png"></p><p>OK，新启动的redis-6380已经成为的新master的从节点。</p><p>我们搭建的是伪哨兵模式，真实环境下，这 3个redis节点应该分别部署在3台服务器上，每台服务器都布置一个sentinel哨兵。</p><p>至此，redis一主二从三哨兵搭建完成，哨兵模式主要解决了高可用问题（HA），保证特殊情况故障自动切换，哨兵盯着你的“redis主从集群”，如果主库死了，它会告诉你新的老大是谁。</p><p>参考：<br><a href="https://www.cnblogs.com/demingblog/p/10295236.html#redis-cluster" target="_blank" rel="noopener">https://www.cnblogs.com/demingblog/p/10295236.html#redis-cluster</a><br><a href="https://blog.csdn.net/cyfblog/article/details/100340640" target="_blank" rel="noopener">https://blog.csdn.net/cyfblog/article/details/100340640</a></p>]]></content>
    
    <summary type="html">
    
      使用docker安装redis哨兵(sentinel)
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/categories/Docker/"/>
    
      <category term="Redis" scheme="http://blog.gaoyp.cn/categories/Docker/Redis/"/>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/tags/Docker/"/>
    
      <category term="Redis" scheme="http://blog.gaoyp.cn/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>使用docker安装redis主从模式</title>
    <link href="http://blog.gaoyp.cn/2020/02/09/redis-02/"/>
    <id>http://blog.gaoyp.cn/2020/02/09/redis-02/</id>
    <published>2020-02-09T08:26:11.000Z</published>
    <updated>2020-03-09T02:10:03.627Z</updated>
    
    <content type="html"><![CDATA[<h2 id="redis主从复制"><a href="#redis主从复制" class="headerlink" title="redis主从复制"></a>redis主从复制</h2><p>前一节我们搭建了单体redis应用，假设我们生产环境使用了一台redis，redis挂了怎么办？<br><font color=red>redis主从复制</font>：是备份关系，我们操作主库，数据会同步到从库。</p><p>那么redis主从复制有什么作用呢？</p><ul><li>故障恢复：当主节点故障时，可以由从节点提供服务，快速的故障转移</li><li>负载均衡：可以在主从复制的基础上，配合读写分离，由主节点负责写，从节点负责读取数据，从而分担服务器的负载压力，大大提高redis的并发量。</li></ul><p>本节我们搭建redis 一主二从，读写分离。redis主从是实现redis集群和redis哨兵高可用的基础.</p><h3 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;master&#x2F;conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;master&#x2F;data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;slaver&#x2F;conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;slaver&#x2F;data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;slaver1&#x2F;conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;slaver1&#x2F;data</span></pre></td></tr></table></figure><h3 id="端口约定"><a href="#端口约定" class="headerlink" title="端口约定"></a>端口约定</h3><table><thead><tr><th align="left">角色</th><th align="center">端口</th><th align="right">密码</th><th align="right">容器名称</th></tr></thead><tbody><tr><td align="left">master</td><td align="center">6380</td><td align="right">123456</td><td align="right">redis-6380</td></tr><tr><td align="left">slaver</td><td align="center">6381</td><td align="right">123456</td><td align="right">redis-6381</td></tr><tr><td align="left">slaver</td><td align="center">6382</td><td align="right">123456</td><td align="right">redis-6382</td></tr></tbody></table><h3 id="准备redis-conf"><a href="#准备redis-conf" class="headerlink" title="准备redis.conf"></a>准备redis.conf</h3><ol><li>准备一份redis.conf文件 <a href="https://redis.io/download" target="_blank" rel="noopener">https://redis.io/download</a>。复制3份，分别存放到：<br>/usr/local/redis/master-slave/master/conf<br>/usr/local/redis/master-slave/slaver/conf<br>/usr/local/redis/master-slave/slaver/conf</li></ol><p>2.创建自定义网桥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker network inspect redis-master-slaver</span></pre></td></tr></table></figure><p>这样我们容器间就可以使用容器名来通信了，避免出现ip变化后主从容器无法通信问题。</p><ol start="3"><li>分别修改这3份redis.conf的以下内容<br>master:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">requirepass 123456 #给redis设置密码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0 # 表示任意ip可连</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">appendonly yes #开启redis aof持久化</span></pre></td></tr></table></figure>slaver:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">requirepass 123456 #给redis设置密码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0 # 表示任意ip可连</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">appendonly yes #开启redis aof持久化</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">slaveof redis-6380 6379 #master容器内的ip端口</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">masterauth 123456 #master节点的密码</span></pre></td></tr></table></figure>slaver1:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">requirepass 123456 #给redis设置密码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0 # 表示任意ip可连</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">appendonly yes #开启redis aof持久化</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">slaveof redis-6380 6379 #master容器内的ip端口</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">masterauth 123456 #master节点的密码</span></pre></td></tr></table></figure>注意：</li></ol><ul><li>slaveof redis-6380 6379 这里指定的master端口6379是容器内的端口，不能指定为6380，否则slaver无法连接master。</li><li>daemonize 不能设置为yes，否则无法启动。参考:<a href="https://blog.csdn.net/Mr_Yang__/article/details/81906691" target="_blank" rel="noopener">https://blog.csdn.net/Mr_Yang__/article/details/81906691</a></li></ul><h3 id="创建redis容器"><a href="#创建redis容器" class="headerlink" title="创建redis容器"></a>创建redis容器</h3><ul><li>master 主库<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 6380:6379 --name redis-6380 --net&#x3D;redis-master-slaver \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;master&#x2F;conf&#x2F;redis.conf:&#x2F;etc&#x2F;redis&#x2F;redis.conf \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;master&#x2F;data:&#x2F;data redis:5.0.7 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">redis-server &#x2F;etc&#x2F;redis&#x2F;redis.conf</span></pre></td></tr></table></figure></li><li>slaver 从库<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 6381:6379 --name redis-6381 --net&#x3D;redis-master-slaver \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;slaver&#x2F;conf&#x2F;redis.conf:&#x2F;etc&#x2F;redis&#x2F;redis.conf \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;slaver&#x2F;data:&#x2F;data redis:5.0.7 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">redis-server &#x2F;etc&#x2F;redis&#x2F;redis.conf</span></pre></td></tr></table></figure></li><li>slaver1 从库<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 6382:6379 --name redis-6382 --net&#x3D;redis-master-slaver \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;slaver1&#x2F;conf&#x2F;redis.conf:&#x2F;etc&#x2F;redis&#x2F;redis.conf \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;master-slaver&#x2F;slaver1&#x2F;data:&#x2F;data redis:5.0.7 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">redis-server &#x2F;etc&#x2F;redis&#x2F;redis.conf</span></pre></td></tr></table></figure><h3 id="检验功能"><a href="#检验功能" class="headerlink" title="检验功能"></a>检验功能</h3><h4 id="查看master容器"><a href="#查看master容器" class="headerlink" title="查看master容器"></a>查看master容器</h4><img src="/images/redis/redis-6380-info.png" alt="redis-6380-info.png"></li></ul><p>可以看到role:master，以及2个slaver。我们添加一个String 类型的键值对</p><h4 id="查看slaver1容器"><a href="#查看slaver1容器" class="headerlink" title="查看slaver1容器"></a>查看slaver1容器</h4><p><img src="/images/redis/redis-6381-info.png" alt="redis-6381-info.png"></p><p>可以看到role:slave，可以看到master节点信息。<br>通过 get s1 命令可以获取到1234qwer ,说明我们同步了master主节点数据。<br>通过 set s2 123 时，报(error) READONLY You can’t write against a read only replica.说明从节点是只读的。</p><h4 id="查看slaver1容器-1"><a href="#查看slaver1容器-1" class="headerlink" title="查看slaver1容器"></a>查看slaver1容器</h4><p><img src="/images/redis/redis-6382-info.png" alt="redis-6382-info.png"><br>slaver2和slaver1相同。</p><h3 id="树结构"><a href="#树结构" class="headerlink" title="树结构"></a>树结构</h3><p>我们来查看一下目前的树结构,可以看到主从3个redis容器的配置文件，及产生的持久化文件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">[root@localhost master-slaver]# tree</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">├── master</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">│   ├── conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">│   │   └── redis.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">│   └── data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">│       ├── appendonly.aof</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">│       └── dump.rdb</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">├── slaver</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">│   ├── conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">│   │   └── redis.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">│   └── data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">│       ├── appendonly.aof</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">│       └── dump.rdb</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">└── slaver1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    ├── conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    │   └── redis.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    └── data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        ├── appendonly.aof</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        └── dump.rdb</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">9 directories, 9 files</span></pre></td></tr></table></figure><h3 id="异常情况"><a href="#异常情况" class="headerlink" title="异常情况"></a>异常情况</h3><p>我们这里模拟下可能发生的异常情况。</p><h4 id="master节点损坏"><a href="#master节点损坏" class="headerlink" title="master节点损坏"></a>master节点损坏</h4><p>我们关掉master：redis-6380，模式主节点损坏情况，此时运维人员准备先将redis-6381，设置为主节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker stop redis-6380</span></pre></td></tr></table></figure><p>修改redis-6381的redis.conf文件,注释掉下面2行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"># slaveof redis-6380 6379 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"># masterauth 123456</span></pre></td></tr></table></figure><p>此时我们修改redis-6382的redis.conf文件的以下内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">slaveof redis-6381 6379</span></pre></td></tr></table></figure><p>重新启动redis-6381、redis-6382</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker restart redis-6381</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker restart redis-6382</span></pre></td></tr></table></figure><h4 id="查看redis-6381"><a href="#查看redis-6381" class="headerlink" title="查看redis-6381"></a>查看redis-6381</h4><p><img src="/images/redis/master-6381-info.png" alt="master-6381-info.png"></p><p>可以看到redis-6381已经升级为 master节点。</p><h4 id="查看redis-6382"><a href="#查看redis-6382" class="headerlink" title="查看redis-6382"></a>查看redis-6382</h4><p><img src="/images/redis/slaver-6382-info.png" alt="slaver-6382-info.png"></p><p>这样我们就实现了redis主从复制，读写分离。主从模式保证了数据备份，发生故障依然需要运维人员施工。</p><p>参考：<br><a href="https://blog.csdn.net/qq_28804275/article/details/80907796" target="_blank" rel="noopener">https://blog.csdn.net/qq_28804275/article/details/80907796</a><br><a href="https://www.cnblogs.com/demingblog/p/10295236.html" target="_blank" rel="noopener">https://www.cnblogs.com/demingblog/p/10295236.html</a></p>]]></content>
    
    <summary type="html">
    
      使用docker安装redis 主从模式
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/categories/Docker/"/>
    
      <category term="Redis" scheme="http://blog.gaoyp.cn/categories/Docker/Redis/"/>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/tags/Docker/"/>
    
      <category term="Redis" scheme="http://blog.gaoyp.cn/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>使用docker安装单点redis</title>
    <link href="http://blog.gaoyp.cn/2020/02/08/redis-01/"/>
    <id>http://blog.gaoyp.cn/2020/02/08/redis-01/</id>
    <published>2020-02-08T08:58:42.000Z</published>
    <updated>2020-03-09T02:09:54.108Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装单个redis"><a href="#安装单个redis" class="headerlink" title="安装单个redis"></a>安装单个redis</h2><ol><li>拉取镜像,我使用的是5.0.7版本。<a href="https://hub.docker.com/_/redis/?tab=tags" target="_blank" rel="noopener">https://hub.docker.com/_/redis/?tab=tags</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker pull redis:5.0.7</span></pre></td></tr></table></figure></li><li>准备一份redis.conf文件 <a href="https://redis.io/download" target="_blank" rel="noopener">https://redis.io/download</a>，使用 xftp 上传到 /usr/local/redis/conf下。</li></ol><p>注意：默认docker运行的redis是不存在配置文件的，即无配置启动.<br>另外还可以通过wget下载redis.conf：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;download.redis.io&#x2F;redis-stable&#x2F;redis.conf</span></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;usr&#x2F;local&#x2F;redis&#x2F;data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;usr&#x2F;local&#x2F;redis&#x2F;conf</span></pre></td></tr></table></figure><p>上传时发现一直报错，因为我是使用admin登录的，传输到虚拟机（服务器）的文件夹（目的地的文件夹）的权限不够。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">chmod 777 &#x2F;usr&#x2F;local&#x2F;redis&#x2F;conf</span></pre></td></tr></table></figure><p>再次上传,然后把权限改回来，777权限很危险，尽量不要这么设置。</p><p>修改redis.conf中的以下内容</p><ul><li>requirepass 123456 #给redis设置密码</li><li>bind 127.0.0.1 # 注释掉这部分，表示任意ip可连</li><li>appendonly yes #开启redis aof持久化</li></ul><ol start="3"><li>创建redis容器</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 6379:6379 --name redis-6379 -v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;conf&#x2F;redis.conf:&#x2F;etc&#x2F;redis&#x2F;redis.conf -v &#x2F;usr&#x2F;local&#x2F;redis&#x2F;data:&#x2F;data redis:5.0.7 redis-server &#x2F;etc&#x2F;redis&#x2F;redis.conf</span></pre></td></tr></table></figure><p><img src="/images/redis/docker-redis-single.png" alt="docker-redis-single"></p><ul><li>-p 6379:6379:把容器内的6379端口映射到宿主机6379端口</li><li>-v /usr/local/redis/conf/redis.conf:/etc/redis/redis.conf:把宿主机配置好的redis.conf放到容器内的这个位置中</li><li>-v /usr/local/redis/data:/data:把redis持久化的数据在宿主机内显示，做数据备份</li><li>redis-server /etc/redis/redis.conf：这个是关键配置，让redis不是无配置启动，而是按照这个redis.conf的配置启动</li><li>–appendonly yes：redis启动后数据持久化</li></ul><p>使用redis-Desktop连接<br><img src="/images/redis/redis-Desktop-single.png" alt="redis-Desktop-single.png"></p><p>我们使用命令向redis中插入几个String类型的值，再次查看/usr/local/redis/data目录,发现已经生成了持久化文件。</p><p><img src="/images/redis/single-data.png" alt="single-data.png"></p><p>单体redis较为简单，完工！</p>]]></content>
    
    <summary type="html">
    
      使用docker安装单点redis
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/categories/Docker/"/>
    
      <category term="Redis" scheme="http://blog.gaoyp.cn/categories/Docker/Redis/"/>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/tags/Docker/"/>
    
      <category term="Redis" scheme="http://blog.gaoyp.cn/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>docker 数据存储笔记</title>
    <link href="http://blog.gaoyp.cn/2020/02/04/docker-06/"/>
    <id>http://blog.gaoyp.cn/2020/02/04/docker-06/</id>
    <published>2020-02-04T02:22:09.000Z</published>
    <updated>2020-03-11T12:50:15.667Z</updated>
    
    <content type="html"><![CDATA[<p>Docker容器在运行的时候会产生数据，为了不让这些数据随着容器的删除而删除，Docker支持数据持久化。</p><p>Docker数据持久化主要有三种种方式：volume, bind mounts, tmpfs mounts</p><p><img src="/images/docker/types-of-mounts-volume.png" alt="types-of-mounts-volume.png"></p><p>这张图很好的说明了三者的关系:</p><ul><li>volume 使用volume数据将持久化在Docker管理的volume中（保存在宿主机 /var/lib/docker/volumes目录下）</li><li>bind mount是直接挂载的宿主机的文件目录，将宿主机的目录映射到容器中；</li><li>tmpfs mount是将数据写入缓存，容器停止后就会被清理。这种模式不太常用，不做太多介绍。</li></ul><p>使用bind mount，数据将持久化在我们指定的宿主机的某个目录中。挂载宿主机目录时数据覆盖有两个规则：</p><ul><li>如果宿主机目录下内容为空，容器映射目录有数据，则会把容器数据复制到宿主机目录</li><li>如果宿主机目录下内容不为空，则会把宿主机目录下内容映射到容器里，并且容器原数据会隐藏。</li></ul><h2 id="volume方式"><a href="#volume方式" class="headerlink" title="volume方式"></a>volume方式</h2><p>Linux环境下，docker 默认在主机上会有一个特定的区域（/var/lib/docker/volumes/ ），该区域用来存放 volume。</p><pre><code>volume 可以通过 docker volume 进行管理，如创建、删除等操作。volume 在生成的时候如果不指定名称，便会随机生成。</code></pre><p>我们使用docker创建一个mysql容器来验证一下，首先我们看一下mysql:5.7.29的 <a href="https://hub.docker.com/layers/mysql/library/mysql/5.7.29/images/sha256-5e443fc090c75413ffc20665ed1880c7961bc6af8ae8997510fdd7e69d8557ad" target="_blank" rel="noopener">Dockerfile</a>内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">VOLUME [&#x2F;var&#x2F;lib&#x2F;mysql]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">EXPOSE 3306 33060</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">CMD [&quot;mysqld&quot;]</span></pre></td></tr></table></figure><p>其中的 <font color=red>VOLUME [/var/lib/mysql]</font> 表示在Docker创建MySQL容器时，Docker会自动创建一个volume，将MySQL容器中/var/lib/mysql目录下的内容将同步到这个volume中。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7.29</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker run -d --name mysql-5.7.29 --restart&#x3D;always -p 3306:3306 -e MYSQL_ROOT_PASSWORD&#x3D;gaoyipeng  mysql:5.7.29</span></pre></td></tr></table></figure><p>然后就可以看到我们已经创建好了mysql-5.7.29，以及创建的卷信息<br><img src="/images/docker/mysql-volume.png" alt="mysql-volume.png"></p><p>volume 在生成的时候如果不指定名称，便会随机生成（eg:09f037735adf1….）很长不好理解。我们也可以指定名称。<br>我们删除这个容器，使用如下的命令再次创建，指定volume名称为mysql</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d --name mysql-5.7.29 --restart&#x3D;always -p 3306:3306 -e MYSQL_ROOT_PASSWORD&#x3D;gaoyipeng -v mysql:&#x2F;var&#x2F;lib&#x2F;mysql mysql:5.7.29</span></pre></td></tr></table></figure><p><img src="/images/docker/volume-mysql.png" alt="volume-mysql.png"><br>我们使用Navicat链接这个mysql，并创建一个名为docker-volume的数据库。<br><img src="/images/docker/navicat-mysql.png" alt="navicat-mysql"><br><img src="/images/docker/docker-volume.png" alt="docker-volume.png"></p><p>然后我们删除这个容器，使用上面的命令再次创建</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker stop mysql-5.7.29</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker rm mysql-5.7.29</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">docker run -d --name mysql-5.7.29 --restart&#x3D;always -p 3306:3306 -e MYSQL_ROOT_PASSWORD&#x3D;gaoyipeng -v mysql:&#x2F;var&#x2F;lib&#x2F;mysql mysql:5.7.29</span></pre></td></tr></table></figure><p>使用navacat 再次链接，发现之前创建的docker-volume数据库依然存在，说明数据持久化成功。</p><h2 id="bind-mount方式"><a href="#bind-mount方式" class="headerlink" title="bind mount方式"></a>bind mount方式</h2><p>是直接挂载的宿主机的文件目录，将宿主机的目录映射到容器中；和volume方式的区别就是保存容器数据的宿主机目录需要自行指定，不是docker来管理。</p><p>我们修改mysql容器创建命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d --name mysql-5.7.29 --restart&#x3D;always -p 3306:3306 -e MYSQL_ROOT_PASSWORD&#x3D;gaoyipeng -v &#x2F;usr&#x2F;local&#x2F;mysql:&#x2F;var&#x2F;lib&#x2F;mysql mysql:5.7.29</span></pre></td></tr></table></figure><p>这样，容器卷的位置就被指到了宿主机的/usr/local/mysql目录下，而不是/var/lib/docker/volumes。bind mount方式更为灵活。<br><img src="/images/docker/bind-volume-mysql.png" alt="bind-volume-mysql.png"></p><p>我们可以看到宿主机/usr/local/mysql目录下，生成了持久化文件。</p><p><img src="/images/docker/navicat-no-volume.png" alt="navicat-no-volume.png"></p><p>再次使用Navacat连接，发现docker-volume数据库是不存在的，符合预期。</p><p>完工！！！</p><p>参考：<br><a href="https://docs.docker.com/storage/volumes/" target="_blank" rel="noopener">https://docs.docker.com/storage/volumes/</a><br><a href="https://deepzz.com/post/the-docker-volumes-basic.html" target="_blank" rel="noopener">https://deepzz.com/post/the-docker-volumes-basic.html</a><br><a href="https://mrbird.cc/Docker-Volume.html" target="_blank" rel="noopener">https://mrbird.cc/Docker-Volume.html</a></p>]]></content>
    
    <summary type="html">
    
      docker 数据存储笔记
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/categories/Docker/"/>
    
    
      <category term="Mysql" scheme="http://blog.gaoyp.cn/tags/Mysql/"/>
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>系统镜像下载地址</title>
    <link href="http://blog.gaoyp.cn/2020/02/02/system/"/>
    <id>http://blog.gaoyp.cn/2020/02/02/system/</id>
    <published>2020-02-02T15:53:18.000Z</published>
    <updated>2020-02-02T16:05:11.049Z</updated>
    
    <content type="html"><![CDATA[<ol><li><p>windows镜像 下载地址：<a href="https://msdn.itellyou.cn/" target="_blank" rel="noopener">https://msdn.itellyou.cn/</a></p></li><li><p>linux镜像 下载地址：<a href="http://archive.kernel.org/centos-vault/7.0.1406/isos/x86_64/" target="_blank" rel="noopener">http://archive.kernel.org/centos-vault/7.0.1406/isos/x86_64/</a> </p></li></ol><p>此处贴出常用的CentOS 7的地址，其他linux发行版在这个网站也可以找到 <a href="http://archive.kernel.org" target="_blank" rel="noopener">http://archive.kernel.org</a></p>]]></content>
    
    <summary type="html">
    
      系统镜像下载地址
    
    </summary>
    
    
      <category term="其他" scheme="http://blog.gaoyp.cn/categories/%E5%85%B6%E4%BB%96/"/>
    
    
      <category term="其他" scheme="http://blog.gaoyp.cn/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>Docker网络配置笔记</title>
    <link href="http://blog.gaoyp.cn/2020/01/27/docker-05/"/>
    <id>http://blog.gaoyp.cn/2020/01/27/docker-05/</id>
    <published>2020-01-27T02:12:59.000Z</published>
    <updated>2020-03-11T12:50:12.618Z</updated>
    
    <content type="html"><![CDATA[<h2 id="docker网络模式"><a href="#docker网络模式" class="headerlink" title="docker网络模式"></a>docker网络模式</h2><p>Docker自身拥有4种默认的网络模式，另外我们还可以自定义网络。</p><p>在安装Docker时，会在宿主机上创建一个新的网络接口，名字是docker0。docker0是一个虚拟的以太网桥，它专门用于连接容器和本地宿主机网络.<br>每个Docker容器都会在这个接口上分配一个IP地址，接口本身的地址是172.17.0.1，子网掩码是255.255.0.0，也就是说Docker会默认使用172.17.X.X作为子网地址。</p><p><img src="/images/docker/docker0.png" alt="docker0"></p><h3 id="四种默认网络模式"><a href="#四种默认网络模式" class="headerlink" title="四种默认网络模式"></a>四种默认网络模式</h3><ol><li><p>bridge模式（默认模式）：使用--net=bridge指定</p><p>此模式会为每一个容器分配、设置IP等，并将容器连接到一个docker0虚拟网桥，通过docker0网桥以及Iptables nat表配置与宿主机通信。</p></li><li><p>Host模式：使用--net=host指定</p><p>容器和宿主机共享Network namespace。容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用宿主机的IP和端口。使用host模式的容器可以直接使用宿主机的IP地址与外界通信，容器内部的服务端口也可以使用宿主机的端口，不需要进行NAT。</p><p>host模式的优势就是网络性能比较好，但是docker host上已经使用的端口就不能再用了，网络的隔离性不好。</p></li><li><p>Container模式：使用--net=container:NAME_or_ID指定</p><p>容器和另外一个容器共享Network namespace。新创建的容器不会创建自己的网卡，配置自己的 IP，而是和一个指定的容器共享 IP、端口范围等。</p></li><li><p>None模式（默认模式）：使用--net=none指定</p><p>容器有独立的Network namespace，但并没有对其进行任何网络设置，如分配veth pair 和网桥连接，配置IP等。</p><p>注意：这种类型的网络没有办法联网，封闭的网络能很好的保证容器的安全性。</p></li></ol><h2 id="bridge模式（重点）"><a href="#bridge模式（重点）" class="headerlink" title="bridge模式（重点）"></a>bridge模式（重点）</h2><pre><code>我们先来创建2个busybox容器。docker run -itd --name busybox1 busyboxdocker run -itd --name busybox2 busybox</code></pre><p>我们使用 docker network inspect bridge 可以查看bridge网络的详情<br><img src="/images/docker/bridge%E8%AF%A6%E6%83%85.png" alt="bridge详情.png"></p><p>可以看到容器名称，IP地址，Container Id 信息。</p><p>我们进入busybox1容器</p><pre><code>docker exec -it busybox1 sh</code></pre><p>我们看下在 busybox1 容器内部是否可以ping通busybox2的IP。再尝试下是否可以ping通busybox2的 Container Name<br><img src="/images/docker/ping-ip-busybox2.png" alt="ping-ip-busybox2.png"></p><p>我们发现busybox1和busybox2可以通过IP互通，但是无法通知container name通讯。所以默认bridge只支持ip互通。</p><h3 id="link"><a href="#link" class="headerlink" title="-- link"></a>-- link</h3><p>如果我们想让bridge模式的Container之间支持通过Container Name通讯。我们可以使用--link 的方式。<br>我们删除busybox2容器。重新创建busybox2容器，并且让其和busybox1建立网络映射关系。</p><pre><code>docker stop busybox2docker rm busybox2docker run -itd --name busybox2 --link busybox1 busybox</code></pre><p><img src="/images/docker/busybox2-ping-busybox1.png" alt="busybox2-ping-busybox1.png"></p><p>busybox2 容器内部可以通过container name ping通busybox1<br>然而反过来busybox1 容器内部 <strong>不可以</strong> 通过 container name ping通busybox2。</p><p>我们删除busybox1容器。重新创建busybox1容器，并且让其和busybox2建立网络映射关系。</p><pre><code>docker stop busybox1docker rm busybox1docker run -itd --name busybox1 --link busybox2 busybox</code></pre><p><img src="/images/docker/busybox1-ping-busybox2.png" alt="busybox1-ping-busybox2.png"></p><p>这样就可以了.</p><p>总结一下: --link方式可以在容器间建立映射关系。如果想容器间互相通过container name 通信，则容器间都需要 --link 链接。</p><h2 id="自定义网络（重点）"><a href="#自定义网络（重点）" class="headerlink" title="自定义网络（重点）"></a>自定义网络（重点）</h2><p>除了--link 可以实现容器间 container name 通信，还有自定义网桥这个方式。</p><p>命令：</p><pre><code>docker network create -d &lt;bridge|host|container|none&gt; network_name</code></pre><p>下面我们命名一个my-bridge的自定义网络。通常情况下使用如下命令即可创建。</p><pre><code>docker network create -d bridge my-bridge</code></pre><p>模式选择的是默认的bridge。</p><p>使用docker network ls即可查看网络列表<br><img src="/images/docker/my-bridge.png" alt="my-bridge.png"></p><p>使用docker run 创建容器时，添加--net=my-bridge即可配置使用自定义网络。</p><p>如果是已经创建好的容器，通过以下命令可以连接到自定义网络上：<br>    docker network connect my-bridge busybox1<br><img src="/images/docker/my-bridge-box1.png" alt="my-bridge-box1.png"></p><p>那么如何在docker-compose.yml中配置自定义网络呢？</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">services:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  elasticsearch:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    image: elasticsearch:6.4.1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    container_name: elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    environment:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">      - &quot;cluster.name&#x3D;elasticsearch&quot; #集群名称为elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">      - &quot;discovery.type&#x3D;single-node&quot; #单节点启动</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">      - &quot;ES_JAVA_OPTS&#x3D;-Xms512m -Xmx512m&quot; #jvm内存分配为512MB</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    networks:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">      - my-bridge  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">networks:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  my-bridge:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    driver: bridge</span></pre></td></tr></table></figure><p>以上docker-compose.yml同样可以创建my-bridge自定义网络。并且创建的elasticsearch容器会配置使用my-bridge自定义网络。<br><img src="/images/docker/docker-network.png" alt="docker-network.png"></p><p>我们发现自动给my-bridge添加了elk前缀，变为了elk_my-bridge ，elk是docker-compose.yml文件的目录名。感觉是为了避免重名吧，不太清楚了！！</p><p>我们查看下elk_my-bridge详情<br>    docker network inspect elk_my-bridge </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker network inspect elk_my-bridge </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        &quot;Name&quot;: &quot;elk_my-bridge&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        &quot;Id&quot;: &quot;d28de6a1cda8b97a282bdab80a10eeae6ac75acb27c3992f51799dad49f0c98c&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        &quot;Created&quot;: &quot;2020-01-27T22:10:46.179450229+08:00&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        &quot;EnableIPv6&quot;: false,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        &quot;IPAM&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            &quot;Options&quot;: null,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            &quot;Config&quot;: [</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">                &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">                    &quot;Subnet&quot;: &quot;172.19.0.0&#x2F;16&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">                    &quot;Gateway&quot;: &quot;172.19.0.1&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">                &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            ]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        &quot;Internal&quot;: false,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        &quot;Attachable&quot;: true,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        &quot;Ingress&quot;: false,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        &quot;ConfigFrom&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            &quot;Network&quot;: &quot;&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        &quot;ConfigOnly&quot;: false,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        &quot;Containers&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">            &quot;4dbffe4469778db7574198a4336b3637653c434a541c102728b9dcf321824c85&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">                &quot;Name&quot;: &quot;kibana&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">                &quot;EndpointID&quot;: &quot;1dc354be523cc7cbb944545be273d4b0c0b85e0e9b00463213b412a7879a7390&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:13:00:04&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">                &quot;IPv4Address&quot;: &quot;172.19.0.4&#x2F;16&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">            &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">            &quot;71607bb793ed6ee0faf9e9d26967c8588abc8076a2cdf6cf1822fb0f321c2c0c&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">                &quot;Name&quot;: &quot;elasticsearch&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">                &quot;EndpointID&quot;: &quot;e873552071bd5cf9dd86bc564be568ff37ca74ab51c59d1a68d8b416b1cb0da3&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:13:00:02&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">                &quot;IPv4Address&quot;: &quot;172.19.0.2&#x2F;16&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">            &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">            &quot;e5c7736099fe779d7718f35557161a05ba2ba03ddcbf20c73a4146794fbb7df8&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">                &quot;Name&quot;: &quot;logstash&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">                &quot;EndpointID&quot;: &quot;5e8821f7e67780468664b7947be64fdb0bf2de3e8b2b2f73d675dd8e29ee0878&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:13:00:03&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">                &quot;IPv4Address&quot;: &quot;172.19.0.3&#x2F;16&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">        &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">        &quot;Options&quot;: &#123;&#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">        &quot;Labels&quot;: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">            &quot;com.docker.compose.network&quot;: &quot;my-bridge&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">            &quot;com.docker.compose.project&quot;: &quot;elk&quot;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">            &quot;com.docker.compose.version&quot;: &quot;1.22.0&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">]</span></pre></td></tr></table></figure><p>可以看到elk_my-bridge网桥的详情，而且发现容器的IP变为了172.19.X.X不再是默认docker 网段172.17.X.X。应该是自定义网桥的原因吧。<br>elasticsearch，logstash，kibana之间是可以通过容器名来通信的。</p><p>OK，今天就到这吧，2020年春节，冠状病毒肺炎疫情很严峻，闷在家里总结下以前的知识点。愿这次的疫情尽早解决吧，武汉加油！湖北加油！！中国加油！！！</p><p>参考：<br><a href="https://www.cnblogs.com/kaye/p/10508800.html" target="_blank" rel="noopener">https://www.cnblogs.com/kaye/p/10508800.html</a><br><a href="https://blog.csdn.net/wucong60/article/details/83757813" target="_blank" rel="noopener">https://blog.csdn.net/wucong60/article/details/83757813</a><br><a href="https://www.cnblogs.com/zuxing/articles/8780661.html" target="_blank" rel="noopener">https://www.cnblogs.com/zuxing/articles/8780661.html</a><br><a href="https://www.jianshu.com/p/22a7032bb7bd" target="_blank" rel="noopener">https://www.jianshu.com/p/22a7032bb7bd</a><br><a href="https://mrbird.cc/Docker-network.html" target="_blank" rel="noopener">https://mrbird.cc/Docker-network.html</a></p>]]></content>
    
    <summary type="html">
    
      Docker网络配置笔记
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker Compose笔记</title>
    <link href="http://blog.gaoyp.cn/2020/01/26/docker-04/"/>
    <id>http://blog.gaoyp.cn/2020/01/26/docker-04/</id>
    <published>2020-01-26T14:12:54.000Z</published>
    <updated>2020-03-11T12:50:09.323Z</updated>
    
    <content type="html"><![CDATA[<p>Docker Compose 是用于定义和运行多容器 Docker 应用程序的工具。微服务架构的应用系统一般包含若干个微服务，每个微服务可能会部署可能需要用到多个Docker容器，比如MySQL，Redis，Nginx等，单独的去管理每个容器可能会比较麻烦。</p><p>Docker Compose 可以通过一个yml文件来统一管理这些容器，可以极大简化我们的应用部署过程。</p><h2 id="安装Docker-Compose"><a href="#安装Docker-Compose" class="headerlink" title="安装Docker Compose"></a>安装Docker Compose</h2><p>可以参考我的博客：<a href="http://blog.gaoyp.cn/2019/12/26/docker-01/">linux（centos7）安装docker</a></p><h2 id="Docker-Compose-配置指令"><a href="#Docker-Compose-配置指令" class="headerlink" title="Docker Compose 配置指令"></a>Docker Compose 配置指令</h2><p>我们先来看一个docker-compose.yml文件，这个是直接抄鸟哥的，感谢鸟哥。鸟哥博客：<a href="https://mrbird.cc/" target="_blank" rel="noopener">https://mrbird.cc/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">services:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  elasticsearch:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    image: elasticsearch:6.4.1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    container_name: elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    environment:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">      - &quot;cluster.name&#x3D;elasticsearch&quot; #集群名称为elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">      - &quot;discovery.type&#x3D;single-node&quot; #单节点启动</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">      - &quot;ES_JAVA_OPTS&#x3D;-Xms512m -Xmx512m&quot; #jvm内存分配为512MB</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    volumes:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">      - &#x2F;kiki&#x2F;elasticsearch&#x2F;plugins:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">      - &#x2F;kiki&#x2F;elasticsearch&#x2F;data:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    ports:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">      - 9200:9200</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    networks:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">      - my-bridge  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">kibana:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    image: kibana:6.4.1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    container_name: kibana</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    links:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">      - elasticsearch:es #配置elasticsearch域名为es</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    depends_on:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">      - elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    environment:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">      - &quot;elasticsearch.hosts&#x3D;http:&#x2F;&#x2F;es:9200&quot; #因为上面配置了域名，所以这里可以简写为http:&#x2F;&#x2F;es:9200</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    ports:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">      - 5601:5601</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    networks:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">      - my-bridge</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">  logstash:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    image: logstash:6.4.1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    container_name: logstash</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    volumes:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">      - &#x2F;kiki&#x2F;logstash&#x2F;logstash-febs.conf:&#x2F;usr&#x2F;share&#x2F;logstash&#x2F;pipeline&#x2F;logstash.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    depends_on:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">      - elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    links:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">      - elasticsearch:es</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    ports:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">      - 4560:4560</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    networks:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">      - my-bridge</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">networks:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">  my-bridge:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">    driver: bridge</span></pre></td></tr></table></figure><p>以上是一个ELK日志分析系统的docker-compose.yml文件。我们通过这个为例介绍常用的 Docker Compose 配置指令</p><ol><li><p>version：指定本 yml 依从的 compose 哪个版本制定的<br> compose与docker版本对应可以查看<a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noopener">https://docs.docker.com/compose/compose-file/</a><br> 使用 docker version 可以查看docker版本，我虚拟机docker版本是 19.03.5,目前为止 version 3.7 及以下均可。<br> <img src="/images/docker/dockercompose%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB.png" alt="dockercompose对应关系.png"></p></li><li><p>services：多个容器集合。一个service代表一个container，可以通过image创建，也可以通过本地的dockerfile来创建。上栗就创建了3个container。</p></li><li><p>image：使用指定容器运行的镜像</p></li><li><p>container_name：指定自定义容器名称，而不是生成的默认名称。</p></li><li><p>volumes：将主机的数据卷或着文件挂载到容器里。<br> 格式：<br> - 主机主机的数据卷或着文件：容器数据卷或着文件</p></li><li><p>depends_on：设置依赖关系：使用docker-compose up 启动时elasticsearch启动后 kibana和logstash才会启动。关闭时反过来</p></li><li><p>environment：添加环境变量。您可以使用数组或字典、任何布尔值，布尔值需要用引号引起来</p></li><li><p>ports：进行端口映射</p></li><li><p>networks： 配置容器连接的网络,此处设置可名为my-bridge的bridge类型的网络。关于docker 网络，我们下一节再介绍。</p></li><li><p>links： 服务之间可以使用服务名称相互访问，links 允许定义一个别名，从而使用该别名访问其它服务.上面我们设置elasticsearch别名为es。 kibana和logstash可以使用elasticsearch或es访问elasticsearch容器。</p></li><li><p>command: 覆盖容器启动的默认命令</p></li><li><p>build：与image效果相同。不过build是利用Dockerfile构建，Compose 会利用它自动构建镜像，该值可以是一个路径，也可以是一个对象，用于指定 Dockerfile 参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">version: &quot;3.7&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">services:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  webapp:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    build: .&#x2F;dir</span></pre></td></tr></table></figure><p>指定上下文路径为 ./dir ，及使用./dir下的Dockerfile文件构建镜像。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">version: &quot;3.7&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">services:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  webapp:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    build:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">      context: .&#x2F;dir</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">      dockerfile: Dockerfile-alternate</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">      args:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        buildno: 1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">      labels:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        - &quot;com.example.description&#x3D;Accounting webapp&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        - &quot;com.example.department&#x3D;Finance&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        - &quot;com.example.label-with-empty-value&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">      target: prod</span></pre></td></tr></table></figure><p>指定上下文路径为 ./dir ，及使用./dir下的Dockerfile文件构建镜像。</p><ul><li>context：上下文路径。</li><li>dockerfile：指定构建镜像的 Dockerfile 文件命。这里指定 Dockerfile-alternate，不是必须命名为 Dockerfile</li><li>args：添加构建参数，这是只能在构建过程中访问的环境变量。</li><li>labels：设置构建镜像的标签。</li><li>target：多层构建，可以指定构建哪一层。</li></ul></li></ol><h2 id="DockerCompose常用命令"><a href="#DockerCompose常用命令" class="headerlink" title="DockerCompose常用命令"></a>DockerCompose常用命令</h2><blockquote><p>docker-compose up -d</p></blockquote><p>通过docker-compose.yaml文件创建并启动容器，-d，后台启动</p><blockquote><p>docker-compose stop</p></blockquote><p>关闭docker-compose.yaml文件创启动的容器</p><blockquote><p>docker-compose start</p></blockquote><p>启动docker-compose stop命令关闭的容器</p><blockquote><p>docker-compose down</p></blockquote><p>停止并删除创建的容器（同时删除创建的network，volume，container）</p><blockquote><p>docker-compose up</p></blockquote><p>当服务的配置发生更改时，可使用 docker-compose up 命令更新配置.此时，Compose 会删除旧容器并创建新容器，新容器会以不同的 IP 地址加入网络，名称保持不变，任何指向旧容起的连接都会被关闭，重新找到新容器并连接上去</p><h2 id="搭建-ELK日志分析系统"><a href="#搭建-ELK日志分析系统" class="headerlink" title="搭建 ELK日志分析系统"></a>搭建 ELK日志分析系统</h2><p>接下来我们实践一下，使用DockerCompose 搭建一个ELK日志分析系统。</p><p>ELK:（ELK 由 ElasticSearch 、 Logstash 和 Kiabana 三个开源工具组成）,Elasticsearch用于存储日志信息，Logstash用于收集日志，Kibana用于图形化展示。</p><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ol><li><p>linux Elasticsearch 默认使用 mmapfs目录来存储其索引。操作系统对mmap计数的限制可能太低，这可能会导致内存不足异常。在Linux上，可以通过运行以下命令来增加限制 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count&#x3D;262144</span></pre></td></tr></table></figure></li><li><p>创建数据挂载路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;kiki&#x2F;elk # 创建ELK Docker Compose文件存储路径</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;kiki&#x2F;elasticsearch&#x2F;data # 创建Elasticsearch数据挂载路径</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;kiki&#x2F;elasticsearch&#x2F;plugins # 创建Elasticsearch插件挂载路径</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;usr&#x2F;local&#x2F;kiki&#x2F;logstash # 创建Logstash配置文件存储路径</span></pre></td></tr></table></figure></li><li><p>在/usr/local/kiki/logstash 路径下创建logstash-kiki.conf配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">input &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  tcp &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    mode &#x3D;&gt; &quot;server&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    host &#x3D;&gt; &quot;0.0.0.0&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    port &#x3D;&gt; 4560</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    codec &#x3D;&gt; json_lines</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">output &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  elasticsearch &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    hosts &#x3D;&gt; &quot;es:9200&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    index &#x3D;&gt; &quot;kiki-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>logstash-kiki.conf定义了logstash的input和output。</p></li><li><p>在/usr/local/kiki/elk下创建docker-compose.yml文件，内容如下，</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">services:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  elasticsearch:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    image: elasticsearch:6.4.1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    container_name: elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    environment:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">      - &quot;cluster.name&#x3D;elasticsearch&quot; #集群名称为elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">      - &quot;discovery.type&#x3D;single-node&quot; #单节点启动</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">      - &quot;ES_JAVA_OPTS&#x3D;-Xms512m -Xmx512m&quot; #jvm内存分配为512MB</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    volumes:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">      - &#x2F;usr&#x2F;local&#x2F;kiki&#x2F;elasticsearch&#x2F;plugins:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">      - &#x2F;usr&#x2F;local&#x2F;kiki&#x2F;elasticsearch&#x2F;data:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    ports:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">      - 9200:9200</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    networks:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">      - my-bridge  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">  kibana:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    image: kibana:6.4.1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    container_name: kibana</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    links:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">      - elasticsearch:es #配置elasticsearch域名为es</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    depends_on:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">      - elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    environment:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">      - &quot;elasticsearch.hosts&#x3D;http:&#x2F;&#x2F;es:9200&quot; #因为上面配置了域名，所以这里可以简写为http:&#x2F;&#x2F;es:9200</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    ports:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">      - 5601:5601</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    networks:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">      - my-bridge</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">  logstash:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    image: logstash:6.4.1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    container_name: logstash</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    volumes:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">      - &#x2F;usr&#x2F;local&#x2F;kiki&#x2F;logstash&#x2F;logstash-kiki.conf:&#x2F;usr&#x2F;share&#x2F;logstash&#x2F;pipeline&#x2F;logstash.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    depends_on:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">      - elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    links:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">      - elasticsearch:es</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    ports:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">      - 4560:4560</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    networks:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">      - my-bridge</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">networks:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">  my-bridge:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">    driver: bridge</span></pre></td></tr></table></figure><p>实际操作如图：<br><img src="/images/docker/elk%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C.png" alt="elk准备工作.png"></p><h4 id="启动ELK"><a href="#启动ELK" class="headerlink" title="启动ELK"></a>启动ELK</h4><p>切换到/usr/local/kiki/elk 目录下，使用docker-compose up 启动。第一次执行需要下载3个镜像。<br><img src="/images/docker/compose%E5%90%AF%E5%8A%A8elk.png" alt="compose启动elk.png"></p><p>使用docker-compose ps查看启动状态<br><img src="/images/docker/compose-ps-elk.png" alt="compose-ps-elk.png"></p><p>发现elasticsearch没有启动，这是因为elasticsearch的data目录权限不够。执行 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">chmod 774 &#x2F;usr&#x2F;local&#x2F;kiki&#x2F;elasticsearch&#x2F;data&#x2F;</span></pre></td></tr></table></figure><p>再次执行docker-compose up -d,再次查看 docker-compose ps<br><img src="/images/docker/elk-ps.png" alt="elk-ps.png"></p><p>logstash-kiki.conf配置文件中用到了json_lines来处理json类型的日志数据。所以我们需要为logstash安装json_lines插件。</p><ul><li>进入到logstash 容器中：docker exec -it logstash /bin/bash</li><li>进入容器的 /bin/ 目录，执行logstash-plugin install logstash-codec-json_lines</li></ul><p><img src="/images/docker/%E5%AE%89%E8%A3%85json_lines.png" alt="安装json_lines.png"></p><p>安装过程很慢，中间报错是因为断网了，再次执行下命令静静等待就行，安装完成后输入exit退出，或者按Ctrl+Q+P 退出。</p><p>访问<a href="http://192.168.85.128:5601/" target="_blank" rel="noopener">http://192.168.85.128:5601/</a> ，192.168.85.128是我虚拟机IP，结果如下：<br><img src="/images/docker/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AEelk.png" alt="浏览器访问elk.png"></p><h3 id="使用ELK"><a href="#使用ELK" class="headerlink" title="使用ELK"></a>使用ELK</h3><p>我们顺便记录下SpringBoot项目如何接入ELK日志分析系统。</p><ol><li><p>首先在POM.xml文件中引入logstash,此处springboot项目使用logback作为日志框架</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    &lt;groupId&gt;net.logstash.logback&lt;&#x2F;groupId&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    &lt;artifactId&gt;logstash-logback-encoder&lt;&#x2F;artifactId&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    &lt;version&gt;6.1&lt;&#x2F;version&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;dependency&gt;</span></pre></td></tr></table></figure></li><li><p>在项目的logback-spring.xml配资文件中添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;!--输出到 logstash的 appender--&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&lt;appender name&#x3D;&quot;logstash&quot; class&#x3D;&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    &lt;destination&gt;192.168.85.128:4560&lt;&#x2F;destination&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    &lt;encoder charset&#x3D;&quot;UTF-8&quot; class&#x3D;&quot;net.logstash.logback.encoder.LogstashEncoder&quot;&#x2F;&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;appender&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&lt;root level&#x3D;&quot;info&quot;&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &lt;appender-ref ref&#x3D;&quot;logstash&quot; &#x2F;&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;root&gt;</span></pre></td></tr></table></figure></li><li><p>168.85.128:4560对应我们刚刚搭建的Logstash地址</p></li><li><p>配置Kiabana<br>访问<a href="http://192.168.85.128:5601/做一些配置" target="_blank" rel="noopener">http://192.168.85.128:5601/做一些配置</a></p></li></ol><ul><li>Kibana管理界面点击左侧Management,点击 Kinaba Index Patterns</li><li>在Index pattern里输入我们在logstash配置文件logstash-kiki.conf里output.index指定的值kiki-logstash-*,点击下一步，注意，这里需要检查elasticsearch中是否有匹配数据。<br>所以，需要按上面的步骤创建springboot项目并启动，否则无法点击Next Step。</li><li>点击Next Step，在下拉框里选择@timestamp</li><li>点击 Create index patterns</li></ul><p><img src="/images/docker/logstash.gif" alt="logstash"> </p><ol start="4"><li>使用postman调用接口，产生日志数据,代码如下<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">package com.sxdx.sso.resource.one.controller;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">import org.springframework.security.access.prepost.PreAuthorize;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">import org.springframework.web.bind.annotation.RestController;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">import java.security.Principal;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">import java.util.HashMap;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">import java.util.Map;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">@Slf4j</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">@RestController</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">public class OneController &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    @GetMapping(&quot;&#x2F;user&quot;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    public Principal user(Principal principal) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        log.info(&quot;获取当前登录人信息&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        return principal;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>我的访问接口访问路径为localhost:8002/one/user。查看是否搜集到了日志数据。</li></ol><p><img src="/images/docker/%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E6%90%9C%E9%9B%86%E5%88%B0%E4%BA%86%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE.png" alt="验证是否搜集到了日志数据.png"> </p><p>可以看到已经获取到了日志数据。完工！！！</p>]]></content>
    
    <summary type="html">
    
      Docker Compose笔记
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/categories/Docker/"/>
    
      <category term="ELK" scheme="http://blog.gaoyp.cn/categories/Docker/ELK/"/>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/tags/Docker/"/>
    
      <category term="ELK" scheme="http://blog.gaoyp.cn/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>docker常用命令及Dockerfile笔记</title>
    <link href="http://blog.gaoyp.cn/2020/01/19/docker-03/"/>
    <id>http://blog.gaoyp.cn/2020/01/19/docker-03/</id>
    <published>2020-01-19T09:22:19.000Z</published>
    <updated>2020-03-11T12:50:04.479Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>docker主要的3个概念：镜像（image）+容器（container）+仓库（repository）</p></blockquote><ul><li>docker镜像：概念类似虚拟机的镜像，可以用来创建新的容器。</li><li>docker仓库：docker仓库概念和git类似。docker仓库是用来包含镜像的位置。</li><li>docker容器：是由docker镜像创建的运行实例。docker容器类似虚拟机，可以执行包含启动，停止，删除等。每个容器间是相互隔离的。容器中会运行特定的运用，包含特定应用的代码及所需的依赖文件。可以把容器看作一个简易版的linux环境（包含root用户权限，进程空间，用户空间和网络空间等）和运行在其中的应用程序。</li></ul><p><img src="/images/docker/%E4%BB%93%E5%BA%93-%E9%95%9C%E5%83%8F-%E5%AE%B9%E5%99%A8%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="仓库-镜像-容器关系图.png"></p><p>我们在这个过程中熟悉经常使用的命令。</p><h2 id="Docker-镜像和容器"><a href="#Docker-镜像和容器" class="headerlink" title="Docker 镜像和容器"></a>Docker 镜像和容器</h2><h3 id="镜像查询"><a href="#镜像查询" class="headerlink" title="镜像查询"></a>镜像查询</h3><p>docker镜像查询地址dockerhub：<a href="https://hub.docker.com/search" target="_blank" rel="noopener">https://hub.docker.com/search</a><br><img src="/images/docker/hub.docker.com.png" alt="hub.docker.com.png"></p><p>我们也可以使用docker search:镜像名称  的方式，搜索镜像,这种方式无法查询镜像tags。<br><img src="/images/docker/%E6%90%9C%E7%B4%A2%E9%95%9C%E5%83%8F.png" alt="搜索镜像.png"></p><p>各个选项说明:</p><ul><li>NAME: 镜像仓库源的名称</li><li>DESCRIPTION: 镜像的描述</li><li>OFFICIAL: 是否 docker 官方发布</li><li>stars: 类似 Github 里面的 star，表示点赞、喜欢的意思。</li><li>AUTOMATED: 自动构建。</li></ul><h3 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h3><p>我们以nginx 为例</p><ul><li>拉取nginx镜像到本地</li></ul><p>docker pull 镜像名称:镜像tags。如果不加 tags，默认拉取最新镜像（latest）。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker pull nginx:latest</span></pre></td></tr></table></figure><p>直接执行命令报：<br>Got permission denied while trying to connect to the Docker daemon socket ….: connect: permission denied</p><p>我们使用su root 命令切换到root用户，再次执行docker pull nginx:latest。<br><img src="/images/docker/%E4%B8%8B%E8%BD%BDnginx%E9%95%9C%E5%83%8F.png" alt="下载nginx镜像.png"></p><p>使用docker images 命令即可查看已经拥有的镜像。<br><img src="/images/docker/%E6%9F%A5%E7%9C%8B%E5%B7%B2%E4%B8%8B%E8%BD%BDimages.png" alt="查看已下载images.png"></p><p>各个选项说明:</p><ul><li>REPOSITORY：表示镜像的仓库源</li><li>TAG：镜像的标签</li><li>IMAGE ID：镜像ID</li><li>CREATED：镜像创建时间</li><li>SIZE：镜像大小</li></ul><h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><p>如果不加 :镜像tags，默认删除最新镜像。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker rmi nginx:latest</span></pre></td></tr></table></figure><h3 id="创建容器"><a href="#创建容器" class="headerlink" title="创建容器"></a>创建容器</h3><p>使用镜像创建一个 nginx容器</p><ol><li>创建挂载目录<br>mkdir -p /usr/local/nginx/{conf,html,logs}</li><li>在/usr/local/nginx/conf下创建nginx.conf文件，作为外置配置文件使用。这样我们就可以很方便的配置nginx。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">user  nginx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">events &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    worker_connections  1024;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">http &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    default_type  application&#x2F;octet-stream;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    sendfile        on;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    #tcp_nopush     on;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    keepalive_timeout  65;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    #gzip  on;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>在/usr/local/nginx/html目录下新建index.html<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&lt;head&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&lt;title&gt;Docker Nginx&lt;&#x2F;title&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;head&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &lt;h1&gt;Docker Nginx&lt;&#x2F;h1&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &lt;p&gt; Hello, Nginx.&lt;&#x2F;p&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;body&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&lt;&#x2F;html&gt;</span></pre></td></tr></table></figure>执行命令：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:80 --name nginx80 --restart&#x3D;always -v &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html -v &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf:&#x2F;etc&#x2F;nginx&#x2F;nginx.conf -v &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;:&#x2F;var&#x2F;log&#x2F;nginx nginx:latest</span></pre></td></tr></table></figure></li></ol><p>如果返回一长串字符即为成功。使用docker ps 即可看到已启动容器列表：<br><img src="/images/docker/docker-nginx80.png" alt="docker-nginx80.png"></p><p>参数说明：</p><ul><li>-d 后台运行</li><li>-p 设置端口映射 宿主机端口：容器端口</li><li>--name 设置容器别名</li><li>--restart=always 设置容器开机启动</li><li>-v 数据卷映射 宿主机目录：容器目录。这样方便我们管理容器配置文件及日志文件</li></ul><p>最后加上nginx:latest，表示我们是以nginx:latest为模板创建的。</p><p>浏览器访问：<a href="http://192.168.85.128/" target="_blank" rel="noopener">http://192.168.85.128/</a> 返回<br><img src="/images/docker/nginx-%E9%A6%96%E9%A1%B5.png" alt="nginx-首页.png"></p><h3 id="基于容器构建镜像"><a href="#基于容器构建镜像" class="headerlink" title="基于容器构建镜像"></a>基于容器构建镜像</h3><p>镜像创建有2种方式：</p><ul><li>从已经创建的容器中更新镜像，并且提交这个镜像</li><li>使用 Dockerfile 指令来创建一个新的镜像</li></ul><p>我们先介绍第一种。<br>在上一步已经创建了一个nginx容器，使用命令docker commit 可创建镜像。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker commit -m&#x3D;&quot;garnett nginx&quot; -a&#x3D;&quot;garnett&quot; nginx80 garnett&#x2F;nginx:1.0</span></pre></td></tr></table></figure><p>参数介绍：<br>-m 设置注释<br>-a 设置作者<br>nginx80 容器名称，也可以使用container id<br>garnett/nginx:1.0  设置镜像的仓库源repository和tags</p><p>使用docker images 查看镜像列表：<br><img src="/images/docker/%E5%AE%B9%E5%99%A8%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F.png" alt="容器创建镜像.png"></p><h3 id="常用命令总结"><a href="#常用命令总结" class="headerlink" title="常用命令总结"></a>常用命令总结</h3><ol><li>docker exec -it &lt;容器ID或名字&gt; /bin/bash   进入容器命令，有个交互式 Shell</li><li>docker ps -a                查看所有的容器命令</li><li>docker stop &lt;容器ID或名字&gt;   停止容器</li><li>docker start &lt;容器ID或名字&gt;  启动容器</li><li>docker restart &lt;容器ID或名字&gt; 重启容器</li><li>docker logs -f &lt;容器ID或名字&gt; 输出容器日志 -f: 让 docker logs 像使用 tail -f 一样来输出容器内部的标准输出。</li><li>docker inspect &lt;容器ID或名字&gt; 返回一个 JSON 文件记录着 Docker 容器的配置和状态信息</li><li>docker images 查看镜像列表</li><li>docker rmi &lt;镜像ID&gt;  删除镜像</li><li>docker rm &lt;容器ID或名字&gt;  删除容器</li><li>docker pull 镜像名：tags  拉取镜像</li><li>docker run … 使用镜像构建容器</li><li>docker commit … 使用容器构建镜像</li></ol><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>我们在上面已经介绍过，Dockerfile可以用来构造镜像，包含了一条条构建镜像所需的指令和说明。</p><h3 id="基于Dockerfile构建镜像"><a href="#基于Dockerfile构建镜像" class="headerlink" title="基于Dockerfile构建镜像"></a>基于Dockerfile构建镜像</h3><h4 id="构建nginx的镜像"><a href="#构建nginx的镜像" class="headerlink" title="构建nginx的镜像"></a>构建nginx的镜像</h4><p>我们先构建一个nginx的镜像。然后再介绍Dockerfile语法。<br>新建一个目录： mkdir -p /usr/local/mydockerfile/nginx，我们在这个目录下创建一个nginx的镜像。<br>使用vim 命令新建一个名为 Dockerfile 文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM nginx:latest</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">RUN echo &#39;这是一个本地构建的nginx镜像&#39; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span></pre></td></tr></table></figure><p>FROM 表示基于nginx:latest 的基础镜像。如果本地没有会使用docker pull 自动下载。<br>RUN 用于执行后面跟着的命令行命令。有以下俩种格式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">shell 格式：</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">RUN &lt;命令行命令&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"># &lt;命令行命令&gt; 等同于，在终端操作的 shell 命令。</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">exec 格式：</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">RUN [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"># 例如：</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"># RUN [&quot;.&#x2F;test.php&quot;, &quot;dev&quot;, &quot;offline&quot;] 等价于 RUN .&#x2F;test.php dev offline</span></pre></td></tr></table></figure><p>注意： FROM 、RUN 等指令需要大写。</p><p>接下来我们在/usr/local/mydockerfile/nginx目录下执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker build -t nginx:1.1 .</span></pre></td></tr></table></figure><p>docker build 命令经常用到-t -f 参数</p><p>-t 指定镜像名称及tag<br>-f 指定 Dockerfile文件地址，因为我们是在/usr/local/mydockerfile/nginx目录下执行的，已经包含了Dockerfile 文件，所以上面的命令不需要-f</p><p>注意：最后的 . 代表本次执行的上下文路径。上下文路径，是指 docker 在构建镜像，有时候想要使用到本机的文件（比如复制），docker build 命令得知这个路径后，会将路径下的所有内容打包。<br>上下文路径下不要放无用的文件，因为会一起打包发送给 docker 引擎，如果文件过多会造成过程缓慢。</p><p>可以看到构建过程及构建好的镜像文件。<br><img src="/images/docker/dockerfile%E6%9E%84%E5%BB%BAnginx%E9%95%9C%E5%83%8F.png" alt="dockerfile构建nginx镜像.png"></p><p>我们使用刚才构建好的镜像创建容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 82:80 --name nginx82 nginx:1.1</span></pre></td></tr></table></figure><p><img src="/images/docker/nginx82.png" alt="nginx82.png">乱码是因为写入容器的/usr/share/nginx/html/index.html 中只包含’这是一个本地构建的nginx镜像’，不是一个正常的html。至此表示我们构建的镜像是可以使用的。</p><h3 id="Dockerfile指令详解"><a href="#Dockerfile指令详解" class="headerlink" title="Dockerfile指令详解"></a>Dockerfile指令详解</h3><ol><li><p>FROM<br>位于Dockerfile开头，表示基于什么镜像构建</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM nginx:latest</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">RUN echo &#39;这是一个本地构建的nginx镜像&#39; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span></pre></td></tr></table></figure></li><li><p>LABEL<br>Dockerfile的元数据，描述作用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM nginx:latest</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">LABEL version&#x3D;&quot;1.0&quot; author&#x3D;&quot;garnett&quot; description&#x3D;&quot;nginx port 82&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">RUN echo &#39;这是一个本地构建的nginx镜像&#39; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span></pre></td></tr></table></figure></li><li><p>RUN<br>运行命令，每次run都会生成一个图层，所以最好使用 &amp;&amp; 将命令合并</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM nginx:latest</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">LABEL version&#x3D;&quot;1.0&quot; author&#x3D;&quot;garnett&quot; description&#x3D;&quot;nginx port 82&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">RUN echo &#39;这是一个本地构建的nginx镜像&#39; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">RUN echo &#39;追加。。。&#39; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span></pre></td></tr></table></figure><p>可以修改为：</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM nginx:latest</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">LABEL version&#x3D;&quot;1.0&quot; author&#x3D;&quot;garnett&quot; description&#x3D;&quot;nginx port 82&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">RUN echo &#39;这是一个本地构建的nginx镜像&#39; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&amp;&amp; echo &#39;追加。。。&#39; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;</span></pre></td></tr></table></figure><ol start="4"><li>ADD 和 COPY<br>ADD 和COPY都可以将上下文目录中复制文件或者目录到容器里指定路径。<br>语法：<pre><code>ADD  &lt;源路径1&gt;  &lt;目标路径&gt;COPY &lt;源路径1&gt;  &lt;目标路径&gt;</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ADD ADD test test&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">COPY ADD test test&#x2F;</span></pre></td></tr></table></figure>区别：<br>ADD 添加的文件是压缩文件的话，会自动解压。<br>COPY 只能复制构建目录下的文件，ADD可以添加一个构建上下文中的文件或目录，也可以是一个URL，如：</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ADD http:&#x2F;&#x2F;wordpress.org&#x2F;latest.zip &#x2F;</span></pre></td></tr></table></figure><ol start="5"><li>CMD<br> 类似于 RUN 指令，用于运行程序，但二者运行的时间点不同:<ul><li>CMD 在docker run 时运行。</li><li>RUN 是在 docker build。</li><li>docker run指定了其他命令，CMD命令会被忽略。</li><li>定义了多个CMD，只有最后一个有效。</li></ul></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">CMD echo &quot;hello docker&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">CMD echo &quot;hello garnett&quot;</span></pre></td></tr></table></figure><p>构建镜像并运行docker run<br>输出hello garnett</p><p>运行 docker run -it [image] /bin/bash 则没有输出。因为/bin/bash覆盖了CMD 指令。</p><ol start="6"><li>ENTRYPOINT<br> 类似于 CMD 指令，但其不会被 docker run 的命令行参数指定的指令所覆盖<ul><li>设置容器启动时运行的命令。</li><li>不会被忽略，一定会执行。</li><li>一般写一个shell脚本作为ENTRYPOINT。</li><li>如果 Dockerfile 中如果存在多个 ENTRYPOINT 指令，仅最后一个生效。</li></ul></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM ubuntu</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">ENTRYPOINT [&quot;&#x2F;bin&#x2F;ls&quot;]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">CMD []</span></pre></td></tr></table></figure><ol start="7"><li>ENV<br>环境变量，定义了环境变量，那么在后续的指令中，就可以使用这个环境变量。</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ENV MYSQL_VERSION 5.7</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">RUN apt-get install -y mysql-server&#x3D;&quot;$&#123;MYSQL_VERSION&#125;&quot;</span></pre></td></tr></table></figure><ol start="8"><li>WORKDIR<br>指定工作目录。用 WORKDIR 指定的工作目录，会在构建镜像的每一层中都存在。（WORKDIR 指定的工作目录，必须是提前创建好的）。</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM ubuntu</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">WORKDIR &#x2F;test # 没有则自动创建test目录</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">WORKDIR demo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">RUN pwd</span></pre></td></tr></table></figure><p>输出 /test/demo。<br>9. VOLUME<br>定义匿名数据卷。在启动容器时忘记挂载数据卷，会自动挂载到匿名卷。</p><ul><li>避免重要的数据，因容器重启而丢失，这是非常致命的。</li><li>避免容器不断变大。</li><li>例如我们用nginx搭建mysql服务，数据文件可以挂到宿主机。以免因容器删除而都是数据</li></ul><p>格式：<br>VOLUME [“&lt;路径1&gt;”, “&lt;路径2&gt;”…]<br>VOLUME &lt;路径&gt;</p><p>在启动容器 docker run 的时候，我们可以通过 -v 参数修改挂载点。</p><ol start="10"><li><p>EXPOSE<br>仅仅只是声明端口。</p><ul><li>帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射。</li><li>在运行时使用随机端口映射时，也就是 docker run -P 时，会自动随机映射 EXPOSE 的端口。<br>格式：<br>EXPOSE &lt;端口1&gt; [&lt;端口2&gt;…]</li></ul></li></ol><p>参考链接：<br><a href="https://www.cnblogs.com/baizhanshi/p/9655102.html" target="_blank" rel="noopener">https://www.cnblogs.com/baizhanshi/p/9655102.html</a><br><a href="https://www.runoob.com/docker" target="_blank" rel="noopener">https://www.runoob.com/docker</a></p>]]></content>
    
    <summary type="html">
    
      docker常用命令及Dockerfile笔记
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/categories/Docker/"/>
    
      <category term="Nginx" scheme="http://blog.gaoyp.cn/categories/Docker/Nginx/"/>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/tags/Docker/"/>
    
      <category term="Nginx" scheme="http://blog.gaoyp.cn/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>Java8 Lambda表达式</title>
    <link href="http://blog.gaoyp.cn/2019/12/29/java8-lamada/"/>
    <id>http://blog.gaoyp.cn/2019/12/29/java8-lamada/</id>
    <published>2019-12-29T10:32:12.000Z</published>
    <updated>2020-01-02T01:42:16.305Z</updated>
    
    <content type="html"><![CDATA[<div class="note info">            <p> Java 8的Lambda表达式，简化了匿名函数的表达方式。Lambda表达式可以直接以内联的形式为函数式接口的抽象方法提供实现，并把整个表达式作为函数式接口的实例。</p><p>什么是函数式接口？简单来说就是只包含一个抽象方法的接口，允许有默认的实现（使用default关键字描述方法）。函数式接口建议使用@FunctionalInterface注解标注，虽然这不是必须的，但是这样做更符合规范。</p>          </div><p>本节主要记录java8 内置函数式接口的使用。</p><h2 id="java8-中常用的函数式接口"><a href="#java8-中常用的函数式接口" class="headerlink" title="java8 中常用的函数式接口"></a>java8 中常用的函数式接口</h2><table><thead><tr><th align="center">函数式接口</th><th align="center">函数描述符</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">Predicate</td><td align="center">T-&gt;boolean</td><td align="center">断言：主要作用就是用于判断作用</td></tr><tr><td align="center">Consumer</td><td align="center">T-&gt;void</td><td align="center">消费者：该函数式接口用于消费一个对象，即接收一个对象，对其执行某些操作，然后没有返回值。</td></tr><tr><td align="center">Supplier</td><td align="center">()-&gt;T</td><td align="center">供应商：无参数，返回T类型的对象</td></tr><tr><td align="center">Function</td><td align="center">T-&gt;R</td><td align="center">它接受一个泛型T的对象，并返回一个泛型R的对象</td></tr></tbody></table><h2 id="Predicate-断言"><a href="#Predicate-断言" class="headerlink" title="Predicate 断言"></a>Predicate 断言</h2><p>源码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">package java.util.function;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">import java.util.Objects;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#x2F;**</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"> * @since 1.8</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> *&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">public interface Predicate&lt;T&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    boolean test(T t);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    default Predicate&lt;T&gt; and(Predicate&lt;? super T&gt; other) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        Objects.requireNonNull(other);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        return (t) -&gt; test(t) &amp;&amp; other.test(t);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    default Predicate&lt;T&gt; negate() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        return (t) -&gt; !test(t);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    default Predicate&lt;T&gt; or(Predicate&lt;? super T&gt; other) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        Objects.requireNonNull(other);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        return (t) -&gt; test(t) || other.test(t);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    static &lt;T&gt; Predicate&lt;T&gt; isEqual(Object targetRef) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        return (null &#x3D;&#x3D; targetRef)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">                ? Objects::isNull</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">                : object -&gt; targetRef.equals(object);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>java.util.function.Predicate<T>接口定义了一个名叫test的抽象方法，它接受泛型T对象，并返回一个boolean。<br>除了抽象方法外，java.util.function.Predicate<T>接口还定义了三个默认方法：and，negate和or，对应“与”，“非”和“或”操作，这样我们便可以复合Lambda表达式了.</p><p>示例代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    &#x2F;**</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">     * 函数式接口：Predicate</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">     *&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    Predicate&lt;Integer&gt; isEven &#x3D; (i) -&gt; i%2 &#x3D;&#x3D;0 ;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F;判断： 是否为偶数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    System.out.println( isEven.test(18) );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F;判断： 大于10 且 为偶数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    System.out.println( isEven.and((i) -&gt; i&gt;10).test(18) );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F;判断： 小于10 或 为偶数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    System.out.println( isEven.or((i) -&gt; i&lt;10).test(18) );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F;判断： 奇数判断</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    System.out.println( isEven.negate().test(18) );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>运行结果为：<br>true<br>true<br>true<br>false</p><h2 id="Consumer-消费者，接收参数，无返回值"><a href="#Consumer-消费者，接收参数，无返回值" class="headerlink" title="Consumer 消费者，接收参数，无返回值"></a>Consumer 消费者，接收参数，无返回值</h2><p>源码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">package java.util.function;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">import java.util.Objects;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">public interface Consumer&lt;T&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    void accept(T t);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    default Consumer&lt;T&gt; andThen(Consumer&lt;? super T&gt; after) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        Objects.requireNonNull(after);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        return (T t) -&gt; &#123; accept(t); after.accept(t); &#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>java.util.function.Consumer<T>定义了一个名叫accept的抽象方法，它接受泛型T的对象，没有返回(void)，函数描述符为(T) -&gt; void。<br>其还提供了一个默认方法andThen</p><p>示例代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    &#x2F;**</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">     * 函数式接口：Consumer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">     *&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    String str &#x3D; &quot;hello&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    Consumer&lt;String&gt; consumer &#x3D; (i) -&gt; System.out.println(i);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F;判断： 输出 &quot;hello&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    consumer.accept(str);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F;判断： 输出&quot;hello&quot; 和 &quot;hello world&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    consumer.andThen((i) -&gt; System.out.println(i+&quot; world&quot;)).accept(str);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><h2 id="Supplier-供应商：无参数，返回T类型的对象"><a href="#Supplier-供应商：无参数，返回T类型的对象" class="headerlink" title="Supplier  供应商：无参数，返回T类型的对象"></a>Supplier  供应商：无参数，返回T类型的对象</h2><p>源码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">package java.util.function;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">public interface Supplier&lt;T&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    T get();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>java.util.function.Supplier<T>很简单，只定义了一个名叫get的抽象方法，它不接收参数，返回泛型T的对象，函数描述符为() -&gt; T</p><p>示例代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    &#x2F;**</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">     * 函数式接口：Supplier</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">     *&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    Supplier&lt;String&gt; supplier &#x3D; () -&gt; new String(&quot;supplier&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    System.out.println(supplier.get());&#x2F;&#x2F; 返回一个String对象&quot;supplier&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><h2 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h2><p>源码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">package java.util.function;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">import java.util.Objects;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#x2F;**</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"> * @since 1.8</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> *&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">public interface Function&lt;T, R&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    R apply(T t);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    default &lt;V&gt; Function&lt;V, R&gt; compose(Function&lt;? super V, ? extends T&gt; before) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        Objects.requireNonNull(before);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        return (V v) -&gt; apply(before.apply(v));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    default &lt;V&gt; Function&lt;T, V&gt; andThen(Function&lt;? super R, ? extends V&gt; after) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        Objects.requireNonNull(after);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        return (T t) -&gt; after.apply(apply(t));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    static &lt;T&gt; Function&lt;T, T&gt; identity() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        return t -&gt; t;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>java.util.function.Function&lt;T, R&gt;接口定义了一个叫作apply的方法，它接受一个泛型T的对象，并返回一个泛型R的对象，函数描述符为(T) -&gt; R<br>除了抽象方法外，java.util.function.Function&lt;T, R&gt;接口还定义了三个默认方法：compose，andThen,identity</p><p>示例代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    &#x2F;**</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">     * 函数式接口：Function</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">     *&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F; 接收一个Integer ,返回一个String</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    Function&lt;Integer,String&gt; function &#x3D; (i)-&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        return Integer.toString(i);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F;接收 integer 123 ，返回String &quot;123&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    System.out.println(function.apply(123));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    System.out.println(function.apply(123) instanceof String);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F;compose 过程为：f(g(2))，也就是 (2*2)+1 ,即把g的执行结果当做f的参数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    Function&lt;Integer, Integer&gt; f &#x3D; (x) -&gt; x + 1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    Function&lt;Integer, Integer&gt; g &#x3D; (x) -&gt; x * 2;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    f.compose(g).apply(2); &#x2F;&#x2F; 5</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F;andThen 过程为：g1(f1(2))，也就是(2+1)*2 ，即把f1的执行结果当做g1的参数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    Function&lt;Integer, Integer&gt; f1 &#x3D; (x) -&gt; x + 1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    Function&lt;Integer, Integer&gt; g1 &#x3D; (x) -&gt; x * 2;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    f1.andThen(g1).apply(2); &#x2F;&#x2F; 6</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><h2 id="最后附上全部代码"><a href="#最后附上全部代码" class="headerlink" title="最后附上全部代码"></a>最后附上全部代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">package com.sxdx.spring.security.oauth2.controller;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">import java.util.function.Consumer;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">import java.util.function.Function;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">import java.util.function.Predicate;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">import java.util.function.Supplier;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">public class Java8TestController &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    public static void main1(String[] args) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        &#x2F;**</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">         * 函数式接口：Predicate</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">         *&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        Predicate&lt;Integer&gt; isEven &#x3D; (i) -&gt; i%2 &#x3D;&#x3D;0 ;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F;判断： 是否为偶数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        System.out.println( isEven.test(18) );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F;判断： 大于10 且 为偶数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        System.out.println( isEven.and((i) -&gt; i&gt;10).test(18) );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F;判断： 小于10 或 为偶数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        System.out.println( isEven.or((i) -&gt; i&lt;10).test(18) );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F;判断： 奇数判断</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        System.out.println( isEven.negate().test(18) );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    public static void main2(String[] args) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        &#x2F;**</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">         * 函数式接口：Consumer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">         *&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        String str &#x3D; &quot;hello&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        Consumer&lt;String&gt; consumer &#x3D; (i) -&gt; System.out.println(i);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F;判断： 输出 &quot;hello&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">        consumer.accept(str);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F;判断： 输出&quot;hello&quot; 和 &quot;hello world&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">        consumer.andThen((i) -&gt; System.out.println(i+&quot; world&quot;)).accept(str);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    public static void main3(String[] args) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        &#x2F;**</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">         * 函数式接口：Supplier</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">         *&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F; 无参，直接返回一个String字符串</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">        Supplier&lt;String&gt; supplier &#x3D; () -&gt; new String(&quot;supplier&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">        System.out.println(supplier.get());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">    public static void main(String[] args) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">        &#x2F;**</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">         * 函数式接口：Function</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">         *&#x2F;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F; 接收一个Integer ,返回一个String</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">        Function&lt;Integer,String&gt; function &#x3D; (i)-&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">            return Integer.toString(i);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">        &#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F;接收 integer 123 ，返回String &quot;123&quot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">        System.out.println(function.apply(123));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">        System.out.println(function.apply(123) instanceof String);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F;compose 过程为：f(g(2))，也就是 (2*2)+1 ,即把g的执行结果当做f的参数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">        Function&lt;Integer, Integer&gt; f &#x3D; (x) -&gt; x + 1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">        Function&lt;Integer, Integer&gt; g &#x3D; (x) -&gt; x * 2;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">        f.compose(g).apply(2); &#x2F;&#x2F; 5</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">        &#x2F;&#x2F;andThen 过程为：g1(f1(2))，也就是(2+1)*2 ，即把f1的执行结果当做g1的参数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">        Function&lt;Integer, Integer&gt; f1 &#x3D; (x) -&gt; x + 1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">        Function&lt;Integer, Integer&gt; g1 &#x3D; (x) -&gt; x * 2;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">        f1.andThen(g1).apply(2); &#x2F;&#x2F; 6</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>参考文章：<a href="https://mrbird.cc/java8lambda2.html" target="_blank" rel="noopener">https://mrbird.cc/java8lambda2.html</a><br>         <a href="https://www.runoob.com/java/java8-lambda-expressions.html" target="_blank" rel="noopener">https://www.runoob.com/java/java8-lambda-expressions.html</a></p>]]></content>
    
    <summary type="html">
    
      Java8 Lambda表达式
    
    </summary>
    
    
      <category term="Java8" scheme="http://blog.gaoyp.cn/categories/Java8/"/>
    
    
      <category term="Java8" scheme="http://blog.gaoyp.cn/tags/Java8/"/>
    
  </entry>
  
  <entry>
    <title>centos7设置docker阿里云镜像加速器</title>
    <link href="http://blog.gaoyp.cn/2019/12/26/docker-02/"/>
    <id>http://blog.gaoyp.cn/2019/12/26/docker-02/</id>
    <published>2019-12-26T02:02:36.000Z</published>
    <updated>2020-03-11T12:50:00.928Z</updated>
    
    <content type="html"><![CDATA[<div class="note info">            <p>国内从 DockerHub 拉取镜像有时会遇到困难，此时可以配置镜像加速器。本节记录如何配置使用阿里云镜像仓库。</p>          </div><h2 id="配置使用阿里云镜像仓库下载镜像"><a href="#配置使用阿里云镜像仓库下载镜像" class="headerlink" title="配置使用阿里云镜像仓库下载镜像"></a>配置使用阿里云镜像仓库下载镜像</h2><h3 id="注册阿里云账号，并登陆"><a href="#注册阿里云账号，并登陆" class="headerlink" title="注册阿里云账号，并登陆"></a>注册阿里云账号，并登陆</h3><p><img src="/images/docker/%E9%98%BF%E9%87%8C%E4%BA%91%E7%99%BB%E5%BD%95.png" alt="阿里云登录.png"></p><h3 id="选择容器镜像服务"><a href="#选择容器镜像服务" class="headerlink" title="选择容器镜像服务"></a>选择容器镜像服务</h3><p><img src="/images/docker/%E9%95%9C%E5%83%8F%E6%9C%8D%E5%8A%A1.png" alt="镜像服务.png"></p><h3 id="选择如下目录，并将截图命令在centos系统上执行"><a href="#选择如下目录，并将截图命令在centos系统上执行" class="headerlink" title="选择如下目录，并将截图命令在centos系统上执行"></a>选择如下目录，并将截图命令在centos系统上执行</h3><p><img src="/images/docker/%E8%AE%BE%E7%BD%AE%E9%95%9C%E5%83%8F%E5%9C%B0%E5%9D%80.png" alt="设置镜像地址.png"></p><h3 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h3><p>此时使用 docker pull 命令下载镜像就会默认使用阿里云了。非常快。下载如下Nginx，大概用了不到5秒钟。<br><img src="/images/docker/%E4%B8%8B%E8%BD%BDnginx.png" alt="下载nginx.png"></p><h2 id="推送自定义docker镜像到阿里云"><a href="#推送自定义docker镜像到阿里云" class="headerlink" title="推送自定义docker镜像到阿里云"></a>推送自定义docker镜像到阿里云</h2><p>我们在上面设置了阿里云的镜像库，接下来演示如何将自定义的镜像推送到自己的阿里云镜像库中，这样就可以对外提供下载了。</p><h3 id="阿里云创建一个命名空间"><a href="#阿里云创建一个命名空间" class="headerlink" title="阿里云创建一个命名空间"></a>阿里云创建一个命名空间</h3><p><img src="/images/docker/%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4.png" alt="命名空间.png"></p><h3 id="准备一个可用来打包的容器"><a href="#准备一个可用来打包的容器" class="headerlink" title="准备一个可用来打包的容器"></a>准备一个可用来打包的容器</h3><p>先docker pull 一个Tomcat 镜像，并以此启动一个Tomcat 容器 ,  通过 <a href="http://192.168.230.129:8080/" target="_blank" rel="noopener">http://192.168.230.129:8080/</a> 可以看到Tomcat容器已经启动。<br><img src="/images/docker/tomcat%E5%AE%B9%E5%99%A8.png" alt="tomcat容器.png"></p><h3 id="将上一步的-gaoyp-tomcat-容器打包成为一个新的镜像"><a href="#将上一步的-gaoyp-tomcat-容器打包成为一个新的镜像" class="headerlink" title="将上一步的 gaoyp-tomcat 容器打包成为一个新的镜像"></a>将上一步的 gaoyp-tomcat 容器打包成为一个新的镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker commit -m&#x3D;“提交的描述信息” -a&#x3D;“作者” 容器ID 要创建的目标镜像名:[标签名]</span></pre></td></tr></table></figure><p>此处定义的镜像为 gaoyp/tomcat ,标签为 v1.0<br><img src="/images/docker/%E5%88%9B%E5%BB%BA%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F.png" alt="创建本地镜像.png"></p><h3 id="创建镜像仓库"><a href="#创建镜像仓库" class="headerlink" title="创建镜像仓库"></a>创建镜像仓库</h3><p><img src="/images/docker/%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93.png" alt="创建镜像仓库.png"></p><p>点击下一步，创建镜像仓库</p><p><img src="/images/docker/%E8%87%AA%E5%AE%9A%E4%B9%89tomcat%E9%95%9C%E5%83%8F.png" alt="自定义tomcat镜像.png"></p><p>点击管理可以看到镜像信息：<br><img src="/images/docker/%E9%95%9C%E5%83%8F%E4%BF%A1%E6%81%AF.png" alt="镜像信息.png"></p><h3 id="推送镜像（参考上图第三步）"><a href="#推送镜像（参考上图第三步）" class="headerlink" title="推送镜像（参考上图第三步）"></a>推送镜像（参考上图第三步）</h3><p><img src="/images/docker/%E6%8E%A8%E9%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F.png" alt="推送自定义镜像.png"></p><h2 id="拉取自定义镜像"><a href="#拉取自定义镜像" class="headerlink" title="拉取自定义镜像"></a>拉取自定义镜像</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-beijing.aliyuncs.com&#x2F;gaoyipeng&#x2F;gaoyp-tomcat:v1.0</span></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      centos7设置docker阿里云镜像加速器
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>linux（centos7）安装docker</title>
    <link href="http://blog.gaoyp.cn/2019/12/26/docker-01/"/>
    <id>http://blog.gaoyp.cn/2019/12/26/docker-01/</id>
    <published>2019-12-26T02:02:36.000Z</published>
    <updated>2020-03-11T12:49:57.813Z</updated>
    
    <content type="html"><![CDATA[<div class="note info">            <p>Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中,然后发布到任何流行的Linux机器或Windows 机器上,也可以实现虚拟化,容器是完全使用沙箱机制,相互之间不会有任何接口。</p>          </div><h2 id="检查内核版本"><a href="#检查内核版本" class="headerlink" title="检查内核版本"></a>检查内核版本</h2><blockquote><p>centos7 必须是3.10及以上: uname ‐r</p></blockquote><p><img src="/images/docker/%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5.png" alt="版本检查.png"></p><h2 id="安装docker前的准备"><a href="#安装docker前的准备" class="headerlink" title="安装docker前的准备"></a>安装docker前的准备</h2><blockquote><p>官网地址：<a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/centos/</a></p></blockquote><h3 id="安装所需的软件包"><a href="#安装所需的软件包" class="headerlink" title="安装所需的软件包"></a>安装所需的软件包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&gt;   device-mapper-persistent-data \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&gt;   lvm2</span></pre></td></tr></table></figure><p><img src="/images/docker/%E5%AE%89%E8%A3%85%E6%89%80%E9%9C%80%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%8C%85.png" alt="安装所需的软件包.png"></p><h3 id="设置存储库"><a href="#设置存储库" class="headerlink" title="设置存储库"></a>设置存储库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum-config-manager \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&gt;     --add-repo \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&gt;     https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span></pre></td></tr></table></figure><p><img src="/images/docker/%E8%AE%BE%E7%BD%AE%E5%AD%98%E5%82%A8%E5%BA%93.png" alt="设置存储库.png"></p><h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><h3 id="安装最新版本docker"><a href="#安装最新版本docker" class="headerlink" title="安装最新版本docker"></a>安装最新版本docker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install docker-ce</span></pre></td></tr></table></figure><p><img src="/images/docker/%E5%AE%89%E8%A3%85docker.png" alt="安装docker.png"></p><h3 id="安装指定版本的docker"><a href="#安装指定版本的docker" class="headerlink" title="安装指定版本的docker"></a>安装指定版本的docker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io</span></pre></td></tr></table></figure><p>其中<VERSION_STRING>可以通过以下命令查看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r</span></pre></td></tr></table></figure><p><img src="/images/docker/%E6%9F%A5%E8%AF%A2docker%E7%89%88%E6%9C%AC.png" alt="查询docker版本.png"></p><p>最终命令如下：</p><blockquote><p>我们以第一个截图第一个为例，以下命令未实践，根据官网说明自己写的，所以没有截图，仅供参考，本人安装的是最新docker</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install docker-ce-19.03.4.ce docker-ce-cli-19.03.4.ce containerd.io</span></pre></td></tr></table></figure><h3 id="安装成功确认"><a href="#安装成功确认" class="headerlink" title="安装成功确认"></a>安装成功确认</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker version</span></pre></td></tr></table></figure><p><img src="/images/docker/%E7%89%88%E6%9C%AC%E6%9F%A5%E8%AF%A2.png" alt="版本查询.png"></p><h3 id="docker启动、关闭"><a href="#docker启动、关闭" class="headerlink" title="docker启动、关闭"></a>docker启动、关闭</h3><p>启动docker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl start docker</span></pre></td></tr></table></figure><p>设置开机启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl enable docker</span></pre></td></tr></table></figure><p><img src="/images/docker/docker%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8.png" alt="docker开机启动.png"></p><p>关闭docker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl stop docker</span></pre></td></tr></table></figure><h2 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h2><h3 id="卸载旧版本docker"><a href="#卸载旧版本docker" class="headerlink" title="卸载旧版本docker"></a>卸载旧版本docker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum remove docker \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">                  docker-client \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">                  docker-client-latest \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">                  docker-common \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">                  docker-latest \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">                  docker-latest-logrotate \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">                  docker-logrotate \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">                  docker-engine</span></pre></td></tr></table></figure><h3 id="卸载新版本"><a href="#卸载新版本" class="headerlink" title="卸载新版本"></a>卸载新版本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum remove docker-ce</span></pre></td></tr></table></figure><p>删除所有图像，容器和卷</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">rm -rf &#x2F;var&#x2F;lib&#x2F;docker</span></pre></td></tr></table></figure><h2 id="docker-镜像查看地址：https-hub-docker-com"><a href="#docker-镜像查看地址：https-hub-docker-com" class="headerlink" title="docker 镜像查看地址：https://hub.docker.com"></a>docker 镜像查看地址：<a href="https://hub.docker.com" target="_blank" rel="noopener">https://hub.docker.com</a></h2><p><img src="/images/docker/%E9%95%9C%E5%83%8F%E6%9F%A5%E8%AF%A2.png" alt="镜像查询.png"></p><h2 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h2><blockquote><p>Docker Compose 是一个用来定义和运行复杂应用的 Docker 工具。<br> 使用 Docker Compose 不再需要使用 shell 脚本来启动容器。(通过 docker-compose.yml 配置)</p></blockquote><h3 id="安装命令"><a href="#安装命令" class="headerlink" title="安装命令"></a>安装命令</h3><p>官网的安装命令太慢，有时无法连接，查阅其他人博客后发现如下安装方式：</p><ol><li>通过GitHub安装（可以通过修改 URL 中的版本，自定义需要的版本）</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sudo curl -L https:&#x2F;&#x2F;github.com&#x2F;docker&#x2F;compose&#x2F;releases&#x2F;download&#x2F;1.22.0&#x2F;docker-compose-&#96;uname -s&#96;-&#96;uname -m&#96; -o &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">sudo chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span></pre></td></tr></table></figure><ol start="2"><li>通过Daocloud镜像安装（可以通过修改 URL 中的版本，自定义需要的版本）</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">curl -L https:&#x2F;&#x2F;get.daocloud.io&#x2F;docker&#x2F;compose&#x2F;releases&#x2F;download&#x2F;1.22.0&#x2F;docker-compose-&#96;uname -s&#96;-&#96;uname -m&#96; &gt; &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span></pre></td></tr></table></figure><h3 id="卸载docker-compose"><a href="#卸载docker-compose" class="headerlink" title="卸载docker-compose"></a>卸载docker-compose</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sudo rm &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span></pre></td></tr></table></figure><h3 id="docker-compose常用命令"><a href="#docker-compose常用命令" class="headerlink" title="docker-compose常用命令"></a>docker-compose常用命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span></pre></td></tr></table></figure><p>后台启动 docker-compose 中的容器，如果没有容器会根据docker-compose内容创建容器，并启动。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker-compose stop</span></pre></td></tr></table></figure><p>停止 docker-compose 中的容器，但不会删除容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker-compose down</span></pre></td></tr></table></figure><p>停止 docker-compose 中的容器并删除容器</p><p>参考博客：<a href="https://www.cnblogs.com/morang/p/9501223.html" target="_blank" rel="noopener">https://www.cnblogs.com/morang/p/9501223.html</a></p>]]></content>
    
    <summary type="html">
    
      linux（centos7）安装docker
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://blog.gaoyp.cn/tags/Docker/"/>
    
  </entry>
  
</feed>
